<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script>
    (function() {
      try {
        var savedTheme = localStorage.getItem('yugioh_theme_mode');
        var sysDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var mode = 'light';
        
        if (savedTheme === 'dark' || (!savedTheme && sysDark)) {
          mode = 'dark';
        }

        if (mode === 'dark') {
          document.documentElement.classList.add('dark-mode');
        }

        var themeColor = (mode === 'dark') ? '#000000' : '#F0F0F0';
        document.write('<meta name="theme-color" id="meta-theme-color" content="' + themeColor + '">');
      } catch(e) {
        console.error(e);
      }
    })();
  </script>
  
  <title>YGO 시냅스 - 보유 카드 관리 시스템</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; box-sizing: border-box; }
    html, body { background-color: var(--bg-body); -webkit-text-size-adjust: 100%; transition: background-color 0.3s ease, padding-left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); overflow-x: hidden; width: 100%; position: relative; }
    body { color: var(--text-primary); padding-left: 0; padding-top: env(safe-area-inset-top); min-height: 100dvh; margin: 0; display: flex; flex-direction: column; }
    :root { --bg-body: #f4f7f6; --bg-surface: #ffffff; --bg-sub: #fafafa; --bg-header: #f5f5f5; --text-primary: #333333; --text-secondary: #666666; --text-muted: #9e9e9e; --primary-color: #009688; --primary-rgb: 0, 150, 136; --primary-light: #b2dfdb; --primary-dark: #00796b; --border-color: #ddd; --error-red: #f44336; --success-green: #2e7d32; --warning-yellow: #fbc02d; --bg-success: #e0f2f1; --bg-fail: #ffebee; --input-bg: #ffffff; --disabled-bg: #e0e0e0; --disabled-text: #9e9e9e; --overlay-bg: rgba(255, 255, 255, 0.95); --nav-bg: #F0F0F0; --nav-text: #424242; --nav-text-active: #009688; --nav-border: rgba(0, 0, 0, 0.1); --nav-shadow: 0 -1px 5px rgba(0,0,0,0.05); --bg-odd-row: #80cbc4; --text-table-light: #424242; --text-table-dark: #333333; --table-border-specific: rgb(200, 240, 240); }
    html.dark-mode { --bg-body: #121212; --bg-surface: #1e1e1e; --bg-sub: #252525; --bg-header: #2c2c2c; --text-primary: #e0e0e0; --text-secondary: #b0b0b0; --text-muted: #757575; --primary-color: #4db6ac; --primary-rgb: 77, 182, 172; --primary-light: #80cbc4; --primary-dark: #26a69a; --border-color: #424242; --error-red: #ef5350; --success-green: #66bb6a; --warning-yellow: #fdd835; --bg-success: #59D981; --bg-fail: #EB5260; --input-bg: #2c2c2c; --disabled-bg: #424242; --disabled-text: #757575; --overlay-bg: rgba(18, 18, 18, 0.9); --nav-bg: #000000; --nav-text: #9e9e9e; --nav-text-active: #4db6ac; --nav-border: rgba(255, 255, 255, 0.1); --nav-shadow: 0 -1px 10px rgba(0,0,0,0.3); --bg-odd-row: #56B0AB; --table-border-specific: rgb(180, 220, 220); }
    html.dark-mode #result-summary-body td, html.dark-mode #move-summary-body td { color: #181818 !important; }
    html.dark-mode .btn.cyan-theme { color: #282828 !important; }
    body, input, button, table, .btn, .modal-content, select { font-family: 'Pretendard', sans-serif !important; }
    #dynamic-header-wrapper { position: relative; width: 100%; max-width: 700px; margin: 20px auto; height: 220px; transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), margin-top 0.4s ease; z-index: 100; overflow: visible; }
    .app-title-container { position: absolute; display: flex; justify-content: center; align-items: center; z-index: 2; width: 220px; margin: 0 !important; top: 30px; left: 50%; margin-left: -110px !important; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .search-box { position: absolute; padding: 0; background: transparent; box-shadow: none; display: flex; flex-direction: column; align-items: center; z-index: 1; margin: 0 !important; top: 130px; left: 10px; width: calc(100% - 20px); margin-left: 0 !important; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); will-change: top, left, width; }
    .search-header-row { width: 100%; max-width: 700px; margin: 0 auto; display: flex; justify-content: flex-start; padding-left: 5px; margin-bottom: 5px; transition: opacity 0.3s ease; }
    .search-row { display: flex; align-items: center; justify-content: flex-start; width: 100%; gap: 8px; max-width: 700px !important; margin: 0 auto; flex-wrap: nowrap; transition: margin 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), max-width 0.4s; }
    body.mode-compact #dynamic-header-wrapper { height: 70px; margin-top: 0; }
    body.mode-compact .app-title-container { top: 27px; left: 10px; margin-left: 0 !important; width: 3.9rem !important; }
    body.mode-compact .search-box { top: 22px; left: 80px; margin-left: 0 !important; width: calc(100% - 90px); align-items: flex-start; }
    body.mode-compact .search-row { margin: 0; }
    body.mode-compact .synapse-logo-container { max-width: 3.9rem; width: 3.9rem; }
    body.mode-compact .synapse-text-logo { opacity: 0; }
    body.mode-compact .title-ygo, body.mode-compact .title-beta { display: none !important; }
    body.mode-compact .search-header-row { opacity: 0; pointer-events: none; height: 0; margin: 0; }
    .synapse-logo-container { position: relative; display: inline-block; max-width: 250px; overflow: hidden; white-space: nowrap; transition: max-width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); vertical-align: middle; }
    .synapse-text-logo { position: relative; z-index: 2; font-size: 2.6rem; font-weight: 900; color: #000000; letter-spacing: 2px; line-height: 1; transition: color 0.3s, opacity 0.3s; }
    html.dark-mode .synapse-text-logo { color: #ffffff; }
    .logo-bg-wrapper { position: absolute; top: 1px; bottom: 1px; left: 0; right: 0; z-index: 1; }
    .bg-triangle-top { position: absolute; top: 0; left: 0; width: 100%; height: 100%; clip-path: polygon(0 0, 100% 0, 100% 100%); background: linear-gradient(to right, rgba(var(--primary-rgb), 0.8), rgba(var(--primary-rgb), 0.6) 50%, rgba(var(--primary-rgb), 0)); }
    .bg-triangle-bottom { position: absolute; top: 0; left: 0; width: 100%; height: 100%; clip-path: polygon(0 0, 100% 100%, 0 100%); background: linear-gradient(to left, rgba(var(--primary-rgb), 0.8), rgba(var(--primary-rgb), 0.6) 50%, rgba(var(--primary-rgb), 0)); }
    .title-ygo { position: absolute; top: -20px; left: 0; width: 100%; text-align: center; font-size: 1rem; font-weight: 700; color: var(--text-primary); letter-spacing: 2px; opacity: 0.8; transition: opacity 0.3s ease; }
    .title-beta { position: absolute; bottom: -25px; left: 0; width: 100%; text-align: center; font-size: 0.85rem; font-weight: 700; color: var(--error-red); letter-spacing: 3px; transition: opacity 0.3s ease; }
    .table-wrapper { width: 100%; max-width: 700px; margin: 0 auto 20px auto; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
    .page-entry-table { width: 100%; border-collapse: collapse; border-spacing: 0; margin: 0; border-style: hidden; }
    .page-entry-table td { padding: 0 !important; margin: 0 !important; vertical-align: middle !important; box-sizing: border-box; border: 1px solid var(--table-border-specific) !important; border-radius: 0px !important; }
    .page-entry-table tbody tr:first-child td { border-top: none !important; } .page-entry-table tbody tr:last-child td { border-bottom: none !important; } 
    .page-entry-table tr td:first-child { border-left: none !important; } .page-entry-table tr td:last-child { border-right: none !important; }
    .page-entry-table .no-cell { width: 40px; text-align: center; font-weight: 800; font-size: 1.1rem; background-color: rgba(0,0,0,0.1); color: inherit; }
    .col-delete { width: 40px; text-align: center; cursor: pointer; color: var(--text-muted); transition: all 0.3s; outline: none; }
    .col-delete:focus { background-color: rgba(0,0,0,0.1); color: var(--error-red); }
    html.dark-mode .col-delete:focus { background-color: rgba(255,255,255,0.2); }
    @media (hover: hover) { .col-delete:hover { background-color: rgba(0,0,0,0.05); color: var(--error-red); } }
    .col-delete.disabled { pointer-events: none; opacity: 0.3; cursor: default; }
    .content-cell { padding: 0; }
    .content-wrapper { width: 100%; height: 100%; margin: 0; padding: 0; box-sizing: border-box; }
    .entry-row-top { display: flex; width: 100%; height: 42px; border-bottom: 1px solid var(--table-border-specific) !important; }
    .name-area { flex: 3; min-width: 0; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--table-border-specific) !important; }
    .no-area { flex: 1; min-width: 110px; flex-shrink: 0; }
    .entry-row-bottom { display: flex; width: 100%; height: 42px; }
    .input-wrap { width: 0; border-right: 1px solid var(--table-border-specific) !important; position: relative; }
    #page-add-table .input-wrap { transition: flex 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    #page-move-table .input-wrap { transition: none !important; }
    .input-wrap:last-child { border-right: none; }
    .w-img { flex: 0 0 27.5%; } .w-rare { flex: 0 0 25%; } .w-loc { flex: 0 0 30%; } .w-qty { flex: 0 0 17.5%; min-width: 0; }
    @media only screen and (min-width: 601px) { .entry-row-bottom .input-wrap, .move-row-bot .input-wrap { flex: 0 0 25%; } .move-row-mid .input-wrap { flex: 1 0 0%; } .name-area { flex: 0 0 75%; } .no-area { flex: 0 0 25%; } .w-qty { min-width: 0; } }
    .move-row-top { display: flex; width: 100%; height: 42px; border-bottom: 1px solid var(--table-border-specific) !important; }
    .move-row-mid { display: flex; width: 100%; height: 42px; border-bottom: 1px solid var(--table-border-specific) !important; }
    .move-row-bot { display: flex; width: 100%; height: 42px; align-items: stretch; }
    .move-row-bot .input-wrap { transition: none !important; }
    .arrow-cell { flex: 0 0 30px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--text-table-light); user-select: none; }
    html.dark-mode .arrow-cell { color: var(--text-table-dark); }
    .w-move-from { flex: 1.5 !important; border-right: 1px solid var(--table-border-specific) !important; }
    .w-move-qty { flex: 0.8 !important; text-align: center; border-right: 1px solid var(--table-border-specific) !important; border-left: 1px solid var(--table-border-specific) !important; }
    .w-move-to { flex: 1.5 !important; border-left: 1px solid var(--table-border-specific) !important; }
    .w-move-illust { flex: 1; border-right: 1px solid var(--table-border-specific) !important; }
    .w-move-rare { flex: 1; }
    input::-webkit-calendar-picker-indicator { display: none !important; }
    .page-entry-table input, .page-entry-table select { width: 100% !important; height: 100% !important; border: none !important; background-color: transparent !important; border-radius: 0 !important; margin: 0 !important; font-size: 0.95rem !important; padding: 0 10px !important; box-shadow: none !important; box-sizing: border-box !important; display: block; cursor: pointer; color: var(--text-table-light); outline: none !important; text-align: center; }
    .page-entry-table input:focus, .page-entry-table select:focus, .custom-input:focus { background-color: rgba(0,0,0,0.15) !important; color: var(--text-primary) !important; }
    .page-entry-table input::placeholder { color: #616161 !important; opacity: 1 !important; }
    html.dark-mode .page-entry-table input::placeholder { color: #3a3a3a !important; opacity: 1 !important; }
    input#card-search::placeholder, #sheet-url::placeholder { color: #B0B0B0 !important; opacity: 1 !important; }
    html.dark-mode input#card-search::placeholder, html.dark-mode #sheet-url::placeholder { color: #666666 !important; opacity: 1 !important; }
    .error-placeholder::placeholder { color: var(--error-red) !important; font-weight: 700; opacity: 1 !important; }
    .page-card-loc, .move-card-to, .move-card-from { appearance: none !important; -webkit-appearance: none !important; text-align: center !important; text-align-last: center !important; padding-right: 10px !important; background-image: none !important; }
    .entry-row-bottom input, .entry-row-bottom select, .move-row-bot input, .move-row-bot select { text-align: left !important; padding: 0 5px !important; }
    .move-row-bot input, .move-row-bot select, .move-row-bot input:placeholder-shown, .move-row-bot input:not(:placeholder-shown), .move-row-bot input:focus { text-align: center !important; text-align-last: center !important; }
    .entry-row-bottom input.page-card-loc:placeholder-shown, .entry-row-bottom input.page-card-qty:placeholder-shown { text-align: center !important; }
    .entry-row-bottom input.page-card-loc:not(:placeholder-shown), .entry-row-bottom input.page-card-loc:focus, .entry-row-bottom input.page-card-qty:not(:placeholder-shown), .entry-row-bottom input.page-card-qty:focus { text-align: left !important; }
    .card-name-input { text-align: center !important; font-weight: 700 !important; font-size: 0.9rem !important; color: inherit !important; padding: 0 10px !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: text; }
    html.dark-mode .page-entry-table input, html.dark-mode .page-entry-table select, html.dark-mode .card-name-disp, html.dark-mode .page-entry-table .no-cell, html.dark-mode .card-link { color: var(--text-table-dark) !important; }
    .entry-group.odd { background-color: var(--bg-odd-row); color: var(--text-table-light); }
    .entry-group.even { background-color: var(--primary-light); color: var(--text-table-light); }
    .card-name-disp { padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; font-size: 0.9rem; color: inherit; width: 100%; line-height: 42px; text-align: center; }
    .card-link { color: inherit; text-decoration: none; cursor: pointer; border-bottom: 1px dotted currentColor; }
    @media (hover: hover) { .card-link:hover { opacity: 0.7; } }
    .add-row-btn-cell { text-align: center; padding: 0 !important; background: transparent !important; border: none !important; box-shadow: none !important; }
    .add-page-row-btn { width: 100%; padding: 8px 12px; background-color: #eeeeee; border: none !important; color: #212121; font-weight: 700; cursor: pointer; transition: all 0.3s; border-radius: 0px !important; margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 20px; }
    html.dark-mode .add-page-row-btn { background-color: var(--bg-sub); color: var(--text-muted); }
    .add-page-row-btn:focus { background-color: #e0e0e0; color: var(--primary-color) !important; outline: none; }
    html.dark-mode .add-page-row-btn:focus { background-color: rgba(255,255,255,0.1); color: var(--primary-color) !important; }
    .qty-control-box { display: flex; align-items: center; background: rgba(0,0,0,0.05); border-radius: 16px; padding: 2px 4px; gap: 8px; }
    html.dark-mode .qty-control-box { background: rgba(255,255,255,0.1); }
    .ctrl-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-weight: 800; transition: background-color 0.3s; user-select: none; }
    .ctrl-val { min-width: 20px; text-align: center; font-weight: 700; }
    .page-btn-container { max-width: 700px; margin: 0 auto; display: flex; justify-content: flex-end; gap: 10px; padding-bottom: 40px; margin-top: 20px; }
    .custom-select-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; }
    .custom-input { width: 100% !important; height: 100% !important; border: none !important; padding-right: 25px !important; box-sizing: border-box; background: var(--bg-surface); cursor: pointer; text-align: center !important; color: var(--text-table-light); }
    html.dark-mode .custom-input { background: transparent; color: var(--text-table-dark); }
    .custom-input:read-only { cursor: pointer; } 
    .arrow-icon { position: absolute; right: 5px; pointer-events: none; font-size: 1.2rem; opacity: 0.7; color: var(--text-table-light); }
    html.dark-mode .arrow-icon { color: var(--text-table-dark); }
    .custom-select-wrapper.active .arrow-icon { transform: rotate(180deg); }
    .custom-select-wrapper.single-option .arrow-icon { display: none; }
    .custom-select-wrapper.no-option .arrow-icon { color: var(--text-muted) !important; }
    .custom-select-wrapper.no-arrow .arrow-icon { display: none; }
    .global-dropdown { position: absolute; background: var(--bg-surface); border: 1px solid var(--border-color); z-index: 9999; list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border-radius: 0; }
    html.dark-mode .global-dropdown { background: #2c2c2c; border-color: #444; }
    .custom-option { padding: 8px 5px; cursor: pointer; transition: background 0.1s; font-size: 0.9rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
    .custom-option:hover, .custom-option.selected { background: var(--bg-sub); color: var(--primary-color); font-weight: 700; }
    .app-sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 240px; background-color: var(--nav-bg); z-index: 900; display: flex; flex-direction: column; padding-top: calc(80px + env(safe-area-inset-top)); transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s ease; transform: translateX(0); box-shadow: none; }
    .nav-item { display: flex; align-items: center; padding: 16px 24px; color: var(--nav-text); cursor: pointer; transition: background-color 0.3s, color 0.3s; text-decoration: none; border-left: 4px solid transparent; }
    .nav-item.active { color: var(--nav-text-active); background-color: rgba(128,128,128,0.15); border-left: 4px solid var(--primary-color); font-weight: 700; }
    .nav-item i { margin-right: 16px; font-size: 24px; }
    .nav-text { font-size: 0.95rem; font-weight: 600; white-space: nowrap; opacity: 1; transition: opacity 0.3s; }
    .mobile-nav-container { display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; height: calc(60px + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); z-index: 1050; justify-content: space-around; align-items: center; background-color: var(--nav-bg); border-top: 1px solid var(--nav-border); box-shadow: var(--nav-shadow); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s ease; transform: translateY(100%); pointer-events: none; }
    .mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--nav-text); font-size: 0.65rem; cursor: pointer; flex: 1; height: 100%; transition: color 0.3s, transform 0.3s; font-weight: 500; min-width: 48px; padding: 6px 0; }
    .mobile-nav-item.active { color: var(--nav-text-active); font-weight: 700; }
    .mobile-nav-item i { font-size: 24px; margin-bottom: 3px; }
    body.is-loading .mobile-nav-container, body.is-loading .app-sidebar { z-index: 11001 !important; pointer-events: none; }
    @media only screen and (min-width: 993px) { body { padding-left: 240px; } }
    @media only screen and (min-width: 601px) and (max-width: 992px) { body { padding-left: 72px; } .app-sidebar { width: 72px; } .nav-text { opacity: 0; display: none; } .nav-item { justify-content: center; padding: 16px 0; border-left: 4px solid transparent; border-right: 0; } .nav-item i { margin-right: 0; } .nav-item.active { border-left: 4px solid var(--primary-color); border-right: 0; } }
    @media only screen and (max-width: 600px) { body { padding-bottom: 80px; padding-left: 0; } .app-sidebar { width: 72px !important; transform: translateX(-100%); overflow: hidden; box-shadow: none !important; border: none !important; } .nav-text { display: none !important; } .mobile-nav-container { transform: translateY(0); pointer-events: auto; } .header-right-container { top: 8px; } .container { margin-left: 0 !important; margin-right: 0 !important; } }
    .header-right-container { position: absolute; top: 8px; right: 12px; display: flex; align-items: center; gap: 10px; z-index: 1100; top: calc(8px + env(safe-area-inset-top)); }
    .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; height: 18px !important; }
    #theme-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; line-height: 1 !important; }
    .theme-switch { display: inline-block; position: relative; margin-bottom: 0; height: 18px !important; width: 36px !important; line-height: 1 !important; vertical-align: middle; }
    .theme-switch input { display: none; }
    .slider { background-color: #ccc; position: absolute; cursor: pointer; top: 0; left: 0; width: 36px; height: 18px; transition: .4s; border-radius: 34px; }
    .slider:before { background-color: white; content: ""; position: absolute; height: 14px; width: 14px; left: 2px; bottom: 2px; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(18px); }
    .region-container { position: relative; z-index: 1002; width: 88px; }
    .region-capsule { display: flex; align-items: center; gap: 0; background-color: var(--bg-surface); border: 1px solid var(--border-color); padding: 4px 6px; border-radius: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); height: 30px; box-sizing: border-box; cursor: pointer; transition: border-radius 0.1s, box-shadow 0.2s; }
    .region-capsule.active { border-radius: 12px 12px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 1px solid transparent; }
    .region-icon { color: var(--text-muted); font-size: 1rem; flex-shrink: 0; }
    .region-text { color: var(--text-primary); font-size: 0.75rem; font-weight: 700; white-space: nowrap; user-select: none; flex: 1; text-align: center; margin-right: 3px; }
    .region-dropdown-list { display: none; position: absolute; top: 100%; right: 0; left: 0; background-color: var(--bg-surface); border: 1px solid var(--border-color); border-top: 1px solid #eee; border-radius: 0 0 12px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); list-style: none; margin: 0; padding: 5px 0; width: 100%; z-index: 1003; text-align: center; }
    html.dark-mode .region-dropdown-list { border-top: 1px solid #444; }
    .region-dropdown-list li { padding: 8px 0; font-size: 0.8rem; color: var(--text-primary); cursor: pointer; white-space: nowrap; }
    
    .container { margin-top: 30px; width: auto !important; max-width: 100% !important; min-height: 60vh; margin-left: 15px !important; margin-right: 15px !important; transition: margin 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); flex: 1 0 auto; position: relative; transform: translate3d(0,0,0); }
    
    #content-slider-wrapper { position: relative; width: 100%; overflow: hidden; transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); min-height: 100px; }
    .content-section { display: none; opacity: 0; width: 100%; transition: opacity 0.4s ease; top: 0; left: 0; }
    .content-section.active { opacity: 1; display: block; }
    #result-area { width: 100%; max-width: 700px; margin: 0 auto; padding-top: 30px; padding-bottom: 30px; overflow-x: auto; }
    .help-trigger-btn { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 4px; transition: color 0.2s; height: 18px !important; line-height: 1 !important; }
    .url-input-container { position: relative; width: 100%; box-sizing: border-box; }
    .search-input-wrapper { flex: 1; min-width: 0; position: relative; background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 24px; padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: border-radius 0.2s ease, box-shadow 0.2s ease; z-index: 1001; }
    .search-input-wrapper.active { border-radius: 24px 24px 0 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 1px solid transparent; }
    #search-btn { border-radius: 50px !important; width: 80px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    input#card-search { text-align: left !important; font-size: 1.1rem; padding-left: 20px !important; padding-right: 40px !important; box-sizing: border-box; color: var(--text-primary); border-bottom: none !important; box-shadow: none !important; height: 46px !important; margin: 0 !important; width: 100%; display: block; }
    .clear-search-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: rgba(0,0,0,0.25); display: none; z-index: 5; transition: color 0.2s; }
    .btn.cyan-theme { background-color: var(--primary-color) !important; font-weight: 600; color: #fff; }
    .btn.cyan-theme:focus { background-color: var(--primary-dark) !important; box-shadow: none !important; }
    .btn.cyan-theme.disabled { background-color: var(--disabled-bg) !important; color: var(--disabled-text) !important; cursor: not-allowed; opacity: 0.6; }
    .custom-dropdown { position: absolute; top: 100%; left: -1px; right: -1px; background-color: var(--bg-surface); border: 1px solid var(--border-color); border-top: 1px solid #eee; border-radius: 0 0 24px 24px; z-index: 1000; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 0; padding: 5px 0 10px 0; list-style: none; }
    html.dark-mode .custom-dropdown { border-top: 1px solid #444; }
    .custom-dropdown li { padding: 8px 20px; cursor: pointer; border-bottom: none; font-size: 0.95rem; color: var(--text-primary); display: block; white-space: normal; transition: background-color 0.1s; }
    .custom-dropdown li.text-suggest { color: var(--primary-color) !important; font-weight: 700 !important; }
    .custom-dropdown li .text-match { color: var(--text-primary) !important; font-weight: 400 !important; }
    .custom-dropdown li.no-result-item { font-style: italic; color: var(--text-muted) !important; cursor: default; pointer-events: none; font-weight: 400 !important; text-align: center; padding: 15px; }
    .dropdown-header { display: flex !important; align-items: center; justify-content: space-between !important; padding: 8px 15px !important; background-color: var(--bg-header) !important; cursor: default !important; }
    .recent-header-item { display: flex !important; align-items: center; justify-content: space-between !important; padding: 8px 20px !important; cursor: default !important; margin-bottom: 5px; }
    .recent-item-row { display: flex !important; align-items: center; justify-content: space-between !important; }
    .item-delete-btn { color: var(--text-muted); font-size: 1rem; padding: 4px; cursor: pointer; display: flex; align-items: center; }
    .input-control-row { display: flex; justify-content: flex-end !important; align-items: center; margin-bottom: 10px; max-width: 700px; width: 100%; margin-left: auto; margin-right: auto; gap: 10px; }
    
    #toast-container { top: 50% !important; left: 50% !important; right: auto !important; bottom: auto !important; transform: translate(-50%, -50%) !important; max-width: 80%; width: auto !important; border-radius: 8px; text-align: center; justify-content: center; position: fixed !important; }
    #toast-container .toast.warning-yellow { background-color: var(--warning-yellow) !important; color: #000 !important; }
    #toast-container .toast.red { background-color: var(--error-red) !important; }
    #toast-container .toast.red.darken-1 { background-color: #d32f2f !important; }
    
    .valid-icon { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); margin-top: -3px; display: none; }
    .guide-btn { cursor: pointer; color: var(--primary-dark); font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 4px; }
    .guide-btn i { transition: transform 0.2s; } 
    .guide-btn.active i { transform: rotate(90deg); }
    .guide-content { background: var(--bg-sub); padding: 18px; border-radius: 8px; font-size: 0.95rem; border: 1px solid var(--border-color); display: none; margin-bottom: 15px; color: var(--text-primary); }
    html.dark-mode .guide-content { color: #b0b0b0; }
    #status-msg { min-height: 22px; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; }
    table { background: var(--bg-surface); font-size: 0.85rem; table-layout: fixed; width: 100%; border-collapse: collapse; color: var(--text-primary); }
    th { background: var(--bg-header); color: var(--text-secondary); font-weight: 700; padding: 10px 4px; text-align: center; border: 1px solid var(--border-color); font-size: 0.8rem; word-break: break-all; border-radius: 0px !important; }
    td { border: 1px solid var(--border-color); text-align: center; padding: 6px 4px; position: relative; word-break: break-all; color: var(--text-primary); border-radius: 0px !important; }
    .modal { border-radius: 12px; width: 95% !important; max-width: 600px !important; background-color: var(--bg-surface); color: var(--text-primary); }
    #add-result-modal, #move-result-modal { max-width: 700px !important; }
    .modal .modal-content { background-color: var(--bg-surface); }
    .modal .modal-footer { background-color: var(--bg-surface); border-top: 1px solid var(--border-color); }
    #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: var(--overlay-bg); z-index: 11000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(2px); transition: padding-left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); padding-left: 0; }
    @media only screen and (min-width: 993px) { #loading-overlay { padding-left: 240px; } }
    @media only screen and (min-width: 601px) and (max-width: 992px) { #loading-overlay { padding-left: 72px; } }
    html.dark-mode #loading-text { color: var(--primary-color) !important; }
    .new-card-box { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: var(--bg-surface); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .summary-split-wrapper { display: flex; width: 100%; }
    .summary-left { width: 40%; background-color: var(--primary-color); color: white; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); text-align: center; padding: 10px; }
    .summary-right { width: 60%; }
    .summary-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .summary-table td { border: 1px solid var(--border-color); border-left: none; padding: 10px; text-align: center; color: var(--text-primary); }
    .summary-table tr:first-child td { border-top: none; }
    .border-double-top { border-top: 3px double var(--border-color) !important; background-clip: padding-box; position: relative; z-index: 1; }
    .summary-label-cell { background-color: var(--bg-sub); color: var(--text-secondary); font-weight: 600; width: 50%; }
    .summary-value-cell { width: 50%; font-weight: 500; }
    .show-more-btn { width: 100%; background-color: var(--bg-sub); color: var(--primary-dark); font-weight: 600; padding: 8px 0; border: none; border-top: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.3s; }
    @media (hover: hover) { .show-more-btn:hover { background-color: var(--border-color); } }
    html.dark-mode .show-more-btn { color: var(--primary-color); }
    .detail-slide-wrapper { max-height: 0; overflow-y: hidden; overflow-x: hidden; transition: max-height 0.4s ease-in-out; border-top: none; width: 100%; box-sizing: border-box; }
    .split-table-wrapper { display: flex; width: 100%; border-top: 1px solid var(--border-color); }
    .fixed-side { flex: 0 0 40%; width: 40%; max-width: 40%; min-width: 0; border-right: 1px solid var(--border-color); background-color: var(--bg-surface); z-index: 2; overflow: hidden; }
    .scroll-side { flex: 0 0 60%; width: 60%; max-width: 60%; min-width: 0; overflow-x: auto; }
    .split-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .split-table th, .split-table td { white-space: nowrap; overflow: hidden; padding: 0 2px !important; }
    .split-table th { background-color: var(--bg-sub); color: var(--text-secondary); font-weight: 600; padding: 8px 4px; font-size: 0.85rem; border-top: none !important; border-left: none !important; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); height: 35px; box-sizing: border-box; }
    .split-table td { padding: 8px 4px; font-size: 0.85rem; border-top: none !important; border-left: none !important; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); height: 35px; box-sizing: border-box; text-align: center; color: var(--text-primary); }
    .split-table th:last-child, .split-table td:last-child { border-right: none; }
    .fixed-side .split-table { table-layout: fixed; width: 100%; }
    .fixed-side th, .fixed-side td { padding: 0 !important; width: 33.33%; min-width: 0; }
    .scroll-side .split-table { table-layout: fixed; }
    .scroll-side th, .scroll-side td { padding: 8px 4px; min-width: 80px; }
    #intro-area { text-align: center; color: var(--text-secondary); padding-top: 40px; padding-bottom: 40px; margin: 0; line-height: 1.8; font-size: 0.95rem; }
    #intro-area a { color: var(--primary-color); font-weight: 700; text-decoration: underline; cursor: pointer; }
    .centered-content-area { text-align: center; padding-top: 10px; padding-bottom: 20px; margin: 0; }
    .content-title { font-weight: 800; } 
    .content-subtitle { color: var(--text-secondary) !important; margin-bottom: 20px; }
    #main-footer { text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 50px; padding-bottom: 30px; }
    .footer-disclaimer { margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem; }
    .footer-disclaimer span { display: inline-block; } 
    .footer-info-box { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; line-height: 1.5; }
    .footer-item { white-space: nowrap; }
    .footer-separator { margin: 0 8px; user-select: none; opacity: 0.5; }
    #main-footer a.maker-link { color: var(--text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s; font-weight: 600; }
    @media (hover: hover) { #main-footer a.maker-link:hover { color: #f44336; } }
    @media only screen and (max-width: 600px) { .footer-separator.mobile-hide { display: none; } .footer-item.copyright { width: 100%; margin-top: 4px; } }
    .sheet-name-display { display: none; }
    .result-icon-area { text-align: center; margin-top: 20px; margin-bottom: 10px; }
    .result-icon-area i { font-size: 4rem; }
    .result-summary, .result-fail-summary { text-align: center; }
    .toggle-result-btn { display: flex; justify-content: center; width: 100%; cursor: pointer; } 
    #result-summary-table-box { max-width: 300px; margin: 0 auto 20px auto; }
    #result-summary-body td:first-child, #move-summary-body td:first-child { width: 80%; } 
    #result-summary-body td:last-child, #move-summary-body td:last-child { width: 20%; white-space: nowrap; }
    #result-success-text { margin-bottom: 4px !important; }
    #result-fail-text { margin-top: 0 !important; }
    #result-detail-box { display: none; margin-top: 5px; }
    .w-qty, .w-move-rare, .w-move-to { border-right: none !important; }
    html.dark-mode input[type="text"], html.dark-mode input[type="number"] { color: var(--text-primary); }
    #sheet-url { width: 100% !important; box-sizing: border-box !important; padding-right: 37px !important; }
    .loading-spinner { width: 20px; height: 20px; border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    input#sheet-url.state-error { border-bottom: 1px solid var(--error-red) !important; box-shadow: 0 1px 0 0 var(--error-red) !important; }
    input#sheet-url.state-warning { border-bottom: 1px solid var(--warning-yellow) !important; box-shadow: 0 1px 0 0 var(--warning-yellow) !important; }
    input#sheet-url.state-success { border-bottom: 1px solid var(--success-green) !important; box-shadow: 0 1px 0 0 var(--success-green) !important; }
  </style>
</head>
<body>

<datalist id="loc-datalist"></datalist>

<ul id="global-custom-options" class="global-dropdown custom-options"></ul>

<aside class="app-sidebar">
    <a class="nav-item" onclick="switchToMode('home')" data-mode="home">
        <i class="material-icons">home</i>
        <span class="nav-text">홈</span>
    </a>
    <a class="nav-item" onclick="switchToMode('add')" data-mode="add">
        <i class="material-icons">library_add</i>
        <span class="nav-text">카드 등록</span>
    </a>
    <a class="nav-item" onclick="switchToMode('move')" data-mode="move">
        <i class="material-icons">import_export</i>
        <span class="nav-text">카드 이동</span>
    </a>
    <a class="nav-item" onclick="switchToMode('discard')" data-mode="discard">
        <i class="material-icons">delete_outline</i>
        <span class="nav-text">카드 제거</span>
    </a>
    <a class="nav-item" onclick="switchToMode('settings')" data-mode="settings">
        <i class="material-icons">settings</i>
        <span class="nav-text">환경 설정</span>
    </a>
</aside>

<div class="mobile-nav-container">
    <div class="mobile-nav-item" onclick="switchToMode('add')" data-mode="add">
        <i class="material-icons">library_add</i>
        <span>등록</span>
    </div>
    <div class="mobile-nav-item" onclick="switchToMode('move')" data-mode="move">
        <i class="material-icons">import_export</i>
        <span>이동</span>
    </div>
    <div class="mobile-nav-item" onclick="switchToMode('home')" data-mode="home">
        <i class="material-icons">home</i>
        <span>홈</span>
    </div>
    <div class="mobile-nav-item" onclick="switchToMode('discard')" data-mode="discard">
        <i class="material-icons">delete_outline</i>
        <span>제거</span>
    </div>
    <div class="mobile-nav-item" onclick="switchToMode('settings')" data-mode="settings">
        <i class="material-icons">settings</i>
        <span>설정</span>
    </div>
</div>

<div class="header-right-container">
    <div class="theme-switch-wrapper">
        <span id="theme-label">다크 모드</span>
        <label class="theme-switch" for="checkbox-theme">
            <input type="checkbox" id="checkbox-theme" onchange="toggleTheme()">
            <div class="slider"></div>
        </label>
    </div>

    <div class="region-container">
        <div id="region-capsule" class="region-capsule" onclick="toggleRegionDropdown(event)">
            <i class="material-icons region-icon">public</i>
            <span id="region-text" class="region-text">한국</span>
        </div>
        <ul id="region-dropdown" class="region-dropdown-list">
            <li onclick="selectRegion('ko', '한국')">한국</li>
            <li onclick="selectRegion('ja', '일본')">일본</li>
            <li onclick="selectRegion('ae', '아시아')">아시아</li>
            <li onclick="selectRegion('cn', '중국')">중국</li>
            <li onclick="selectRegion('en', '영미')">영미</li>
            <li onclick="selectRegion('de', '독일')">독일</li>
            <li onclick="selectRegion('fr', '프랑스')">프랑스</li>
            <li onclick="selectRegion('it', '이탈리아')">이탈리아</li>
            <li onclick="selectRegion('es', '스페인')">스페인</li>
            <li onclick="selectRegion('pt', '포르투갈')">포르투갈</li>
        </ul>
    </div>
</div>

<div id="loading-overlay">
  <div class="preloader-wrapper big active"><div class="spinner-layer spinner-teal-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div></div>
  <p id="loading-text" style="margin-top: 20px; font-weight: bold; color: var(--dark-cyan);">데이터 동기화 중...</p>
</div>

<div class="container">
  
  <div id="dynamic-header-wrapper">
      <div class="app-title-container" onclick="switchToMode('home')" style="cursor:pointer;">
          <span class="title-ygo">유희왕</span>
          <div class="synapse-logo-container">
            <div class="logo-bg-wrapper">
              <div class="bg-triangle-top"></div>
              <div class="bg-triangle-bottom"></div>
            </div>
            <span class="synapse-text-logo">SYNAPSE</span>
          </div>
          <span class="title-beta">BETA</span>
      </div>
      
      <div class="search-box">
        <div class="search-header-row">
            <div class="help-trigger-btn" onclick="switchToMode('settings'); toggleGuide(true);">
                <i class="fas fa-question-circle"></i>
                <span>사용법</span>
            </div>
        </div>
        <div class="search-row">
            <div class="search-input-wrapper" id="search-wrapper">
                <input type="text" id="card-search" autocomplete="off" placeholder="">
                <i id="clear-btn" class="material-icons clear-search-btn" onmousedown="event.preventDefault()">cancel</i>
                <ul id="custom-dropdown" class="custom-dropdown"></ul>
            </div>
            <button id="search-btn" class="btn waves-effect waves-light cyan-theme" onclick="startSearch()"><i class="material-icons">search</i></button>
        </div>
        <div class="sub-row"></div>
      </div>
  </div>

  <div id="content-slider-wrapper">
      <div id="intro-area" class="content-section active" style="display:block; opacity:1;">
        <p>본 서비스는 실물 유희왕 카드의 체계적인 관리를 위해 제작됐습니다.<br>
        사용자가 보유한 카드의 정보는 직접 등록해야 합니다.<br>
        자세한 사용법은 <a onclick="switchToMode('settings'); toggleGuide(true);">[여기]</a>를 확인하세요.</p>
      </div>

      <div id="result-content-wrapper" class="content-section">
          <div id="result-area"></div>
      </div>

      <div id="discard-content-area" class="content-section centered-content-area">
          <h5 class="content-title">카드 제거</h5>
          <p style="color: var(--text-secondary);">폐기 기능을 준비 중입니다.</p>
      </div>

      <div id="add-content-area" class="content-section centered-content-area">
          <h5 class="content-title">카드 등록</h5>
          <p class="content-subtitle">카드 정보를 입력하여 카드를 등록할 수 있습니다.</p>
          
          <div class="input-control-row">
              <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">보관 위치 자동 복사</span>
              <label class="theme-switch" for="auto-copy-switch">
                  <input type="checkbox" id="auto-copy-switch" onchange="toggleAutoCopy()">
                  <div class="slider"></div>
              </label>
          </div>

          <div class="table-wrapper">
              <table id="page-add-table" class="page-entry-table">
                  <tbody id="page-add-tbody">
                  </tbody>
                  <tfoot id="page-add-tfoot">
                      <tr>
                          <td colspan="3" class="add-row-btn-cell">
                              <button class="add-page-row-btn" onclick="addMultipleRows(event)" tabindex="0" onkeydown="handleAddButtonKey(event, 'add')">
                                  <span style="font-weight: 700;">카드 추가 등록</span>
                                  <div class="qty-control-box" onclick="event.stopPropagation()">
                                      <span class="ctrl-btn" onclick="adjustAddCount(-1)">-</span>
                                      <span id="add-row-count" class="ctrl-val">1장</span>
                                      <span class="ctrl-btn" onclick="adjustAddCount(1)">+</span>
                                  </div>
                              </button>
                          </td>
                      </tr>
                  </tfoot>
              </table>
          </div>

          <div class="page-btn-container">
              <button id="add-submit-main-btn" class="btn cyan-theme waves-effect waves-light" onclick="submitPageEntries()" tabindex="0">등록</button>
          </div>
      </div>

      <div id="move-content-area" class="content-section centered-content-area">
          <h5 class="content-title">카드 이동</h5>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">보관 중인 카드의 위치를 변경합니다.</p>
          
          <div class="table-wrapper">
              <table id="page-move-table" class="page-entry-table">
                  <tbody id="page-move-tbody">
                      </tbody>
                  <tfoot id="page-move-tfoot">
                      <tr>
                          <td colspan="3" class="add-row-btn-cell">
                              <button class="add-page-row-btn" onclick="addMultipleMoveRows(event)" tabindex="0" onkeydown="handleAddButtonKey(event, 'move')">
                                  <span style="font-weight: 700;">이동 항목 추가</span>
                                  <div class="qty-control-box" onclick="event.stopPropagation()">
                                      <span class="ctrl-btn" onclick="adjustMoveCount(-1)">-</span>
                                      <span id="add-move-count" class="ctrl-val">1건</span>
                                      <span class="ctrl-btn" onclick="adjustMoveCount(1)">+</span>
                                  </div>
                              </button>
                          </td>
                      </tr>
                  </tfoot>
              </table>
          </div>

          <div class="page-btn-container">
              <button id="move-submit-main-btn" class="btn cyan-theme waves-effect waves-light" onclick="submitMoveEntries()" tabindex="0">이동</button>
          </div>
      </div>

      <div id="settings-content-area" class="content-section centered-content-area">
          <h5 class="content-title">환경 설정</h5>
          <p style="color: var(--text-secondary); margin-bottom: 30px;">구글 시트 연결 및 사용법을 확인합니다.</p>
          
          <div class="settings-container" style="max-width: 600px; margin: 0 auto; text-align: left;">
              <div class="guide-btn" id="guide-accordion-btn" onclick="toggleGuide()"><i class="material-icons">keyboard_arrow_right</i><span>양식 다운로드 및 연결법</span></div>
              <div id="guide-box" class="guide-content"><ol><li><a href="https://docs.google.com/spreadsheets/d/16AVBIJvass2Zl6f4IwMpK5KcZkPOuGATWfo0FIdeOdw/copy" target="_blank" style="color: var(--primary-color); font-weight: 800; text-decoration: underline;">링크</a>를 눌러 양식 시트를 구글 드라이브에 복사합니다.</li><li>해당 파일을 <b style="color: var(--primary-color);">링크가 있는 모든 사용자 / 편집자</b>로 공유 설정을 변경합니다.</li><li>해당 파일의 공유 링크를 입력 후 연결을 눌러주세요.</li></ol></div>
              <div class="url-input-container">
                  <input type="text" id="sheet-url" placeholder="주소 입력 (예 : https://docs.google.com/spreadsheets/...)" oninput="validateSheetLink()">
                  <div id="valid-mark" class="valid-icon"></div>
              </div>
              <div id="status-msg" class="status-msg"></div>

              <div class="settings-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <div style="display: flex; align-items: center;">
                    <button id="disconnect-btn" class="btn red darken-1 waves-effect waves-light" onclick="disconnectSheet()">연결 끊기</button>
                    </div>
                <div>
                    <button class="btn-flat" style="color: var(--text-primary);" onclick="cancelSettings()">취소</button>
                    <button id="confirm-btn" class="btn cyan-theme waves-effect waves-light disabled" onclick="saveSettings()">저장</button>
                </div>
              </div>
          </div>
      </div>
  </div>

  <footer id="main-footer">
    <p class="footer-disclaimer">
        <span>사용자가 입력한 모든 정보는 사용자가 등록한 구글 시트 파일에 기록되며,</span>
        <span>해당 내용은 서버에 저장되지 않습니다.</span>
    </p>
    <div class="footer-info-box">
        <span class="footer-item">ver. 0.21.8</span>
        <span class="footer-separator">|</span>
        <span class="footer-item">Made by <a href="https://www.youtube.com/@참혈" target="_blank" class="maker-link"><i class="fab fa-youtube"></i> 참혈</a></span>
        <span class="footer-separator mobile-hide">|</span>
        <span class="footer-item copyright">© 2026 YGO Synapse. All rights reserved.</span>
    </div>
  </footer>
</div>

<div id="add-result-modal" class="modal">
  <div class="modal-content">
    <div id="result-icon-area" class="result-icon-area"></div>
    <h5 id="add-modal-title" style="font-weight: 800; text-align: center; margin-bottom: 20px;">카드 등록 완료!</h5>
    <p id="result-success-text" class="result-summary"></p>
    <p id="result-fail-text" class="result-fail-summary"></p>
    <div id="result-summary-table-box"><table class="result-table"><tbody id="result-summary-body"></tbody></table></div>
    <div class="toggle-result-btn" onclick="toggleResultDetail_Add()"><span>자세히</span><i id="toggle-icon" class="material-icons" style="font-size:1.2rem; transform: translateY(1px);">keyboard_arrow_down</i></div>
    <div id="result-detail-box" class="result-detail-wrapper">
        <table class="result-table">
            <thead><tr><th style="width:10%;">No</th><th style="width:20%;">카드 이름</th><th style="width:15%;">카드 번호</th><th style="width:15%;">일러스트</th><th style="width:15%;">레어도</th><th style="width:15%;">보관 위치</th><th style="width:10%;">수량</th></tr></thead>
            <tbody id="result-detail-body"></tbody>
        </table>
    </div>
  </div>
  <div class="modal-footer" style="display:flex; justify-content:flex-end; padding-right:24px; gap:8px;">
    <button class="btn cyan-theme modal-close">확인</button>
  </div>
</div>

<div id="move-result-modal" class="modal">
    <div class="modal-content">
        <div id="move-icon-area" class="result-icon-area"></div>
        <h5 id="move-modal-title" style="font-weight: 800; text-align: center; margin-bottom: 20px;">카드 이동 완료!</h5>
        <p id="move-success-text" class="result-summary"></p>
        <div id="result-summary-table-box"><table class="result-table"><tbody id="move-summary-body"></tbody></table></div>
        
        <div class="toggle-result-btn" onclick="toggleResultDetail_Move()"><span>자세히</span><i id="move-toggle-icon" class="material-icons" style="font-size:1.2rem; transform: translateY(1px);">keyboard_arrow_down</i></div>
        <div id="move-result-detail-box" class="result-detail-wrapper" style="display: none; margin-top: 5px; border-top: 1px solid var(--border-color); overflow-x: auto;">
            <table class="result-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">No</th>
                        <th style="width: 20%;">카드 이름</th>
                        <th style="width: 15%;">카드 번호</th>
                        <th style="width: 10%;">일러스트</th>
                        <th style="width: 15%;">레어도</th>
                        <th style="width: 25%;">보관 위치</th>
                        <th style="width: 10%;">수량</th>
                    </tr>
                </thead>
                <tbody id="move-result-body"></tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer" style="display:flex; justify-content:flex-end; padding-right:24px; gap:8px;">
        <button class="btn cyan-theme" onclick="finishMoveProcess()">확인</button>
    </div>
</div>

<div id="add-card-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-weight: 800; margin-bottom: 10px;">카드 등록</h5>
    <span class="modal-subtitle">원하는 카드를 등록할 수 있습니다.</span>
    <div style="overflow-x: auto;">
      <table class="add-modal-table">
        <thead>
            <tr>
                <th style="width: 5%;">No</th>
                <th style="width: 20%;">카드 이름</th>
                <th style="width: 15%;">카드 번호</th>
                <th style="width: 15%;">어나더</th>
                <th style="width: 13%;">레어도</th>
                <th style="width: 12%;">보관 위치</th>
                <th style="width: 8%;">수량</th>
                <th style="width: 12%;">조정</th>
            </tr>
        </thead>
        <tbody id="add-card-tbody"></tbody>
      </table>
    </div>
    <div style="margin-top: 20px; text-align: center;"><button class="btn-flat waves-effect" onclick="addMoreRows()" style="color: var(--primary-color); font-weight: 700;">더 많은 카드를 등록할 건가요?</button></div>
  </div>
  <div class="modal-footer">
    <button class="btn-flat modal-close" style="color: var(--text-primary);">취소</button>
    <span class="tooltipped-wrapper tooltipped" data-position="top" data-tooltip="등록할 수 있는 카드가 없습니다.">
        <button id="add-submit-btn" class="btn cyan-theme disabled" onclick="submitNewCards()">등록</button>
    </span>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwmpn2TEr0cdbLJtgB6UZ51wBeUyAbaRvSPsXpqnttRbXLGj2xYDb5iwNlmqQ4DCpKIGg/exec";
  const STORAGE_KEY = 'yugioh_spreadsheet_id';
  const RECENT_KEY = 'recent_card_searches';
  const THEME_KEY = 'yugioh_theme_mode';
  const REGION_KEY = 'yugioh_region_setting';

  let allProcessingTypes = [], allNames = [], allLocations = [], localCardDatabase = [], rarityMap = {}, clientCache = {}, nameDb = {};
  let rarityMappingRaw = []; 
  let rarityLookup = {}; 
  let cidLookup = {}; 
  let isAppConfigured = false, acInstance = null, isLoading = false, validationTimeout = null;
  let hasRegisteredInSession = false;
  let isContinuingRegistration = false;
  let pendingBlurFn = null; 
  let ownedCardNumbers = []; 
  let nameToNosMap = {}; 
  let currentSheetName = ""; 

  let currentRegion = 'ko';
  let currentMode = 'home'; 
  
  let isAutoCopyEnabled = false;
  let rowAddCount = 1; 

  let rowMoveCount = 1;

  let currentFocus = -1;

  let activeDropdownInput = null;
  // [NEW] Toast State Variables
  let currentToastInstance = null;
  let currentToastMessage = null;

  function showToast(html, classes) {
      // [MODIFIED] Smart replacement
      if (currentToastMessage === html) return; 

      if (currentToastInstance) {
          currentToastInstance.dismiss(); 
      }

      const instance = M.toast({
          html: html,
          classes: classes,
          completeCallback: () => {
              if (currentToastMessage === html) {
                  currentToastMessage = null;
                  currentToastInstance = null;
              }
          }
      });
      
      currentToastInstance = instance;
      currentToastMessage = html;

      const toastContainer = document.getElementById('toast-container');
      const mainContainer = document.querySelector('.container');
      if (toastContainer && mainContainer && toastContainer.parentNode !== mainContainer) {
          mainContainer.appendChild(toastContainer);
      }
  }

  document.addEventListener('DOMContentLoaded', function() {
    loadTheme();
    loadRegion();
    checkClearBtn(); 
    updateActiveNav('home');
    initPageAdd();

    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        let options = {
            onCloseEnd: function(el) { 
                if(el.id === 'add-card-modal') {
                    if(!el.dataset.keepData) resetAddModal();
                    else delete el.dataset.keepData; 
                }
                if(el.id === 'add-result-modal') {
                   handleContinueRegistration();
                }
            } 
        };
        if (modal.id === 'add-result-modal' || modal.id === 'move-result-modal') {
            options.dismissible = false; 
        }
        M.Modal.init(modal, options);
    });

    M.Tooltip.init(document.querySelectorAll('.tooltipped'));
    
    const searchInput = document.getElementById('card-search');
    const handleFocusOrClick = () => {
        if (!localStorage.getItem(STORAGE_KEY)) {
            searchInput.blur();
            switchToMode('settings'); 
            showToast('구글 시트 연결이 필요합니다.', 'warning-yellow black-text');
            toggleGuide(true);
            return;
        }
        const val = searchInput.value.trim();
        if (!val) { showRecentInDropdown(); } else { filterAndShowDropdown(searchInput.value); }
    };
    searchInput.addEventListener('click', handleFocusOrClick);
    searchInput.addEventListener('focus', handleFocusOrClick);
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value;
        if (!val) { showRecentInDropdown(); }
        else filterAndShowDropdown(val);
        checkClearBtn(); 
    });
    
    const dropdown = document.getElementById('custom-dropdown');
    dropdown.addEventListener('mousedown', function(e) {
        e.preventDefault(); 
        const target = e.target;
        if (target.classList.contains('clear-all-btn')) {
            localStorage.removeItem(RECENT_KEY);
            showRecentInDropdown();
            return;
        }
        if (target.classList.contains('item-delete-btn') || target.closest('.item-delete-btn')) {
            const delBtn = target.classList.contains('item-delete-btn') ? target : target.closest('.item-delete-btn');
            const li = delBtn.closest('li');
            if (li && li.dataset.val) deleteRecentItem(li.dataset.val);
            return;
        }
        const li = target.closest('li');
        if (li && !li.classList.contains('recent-header-item') && !li.classList.contains('no-result-item')) {
            const val = li.dataset.val;
            if (val) {
                document.getElementById('card-search').value = val;
                checkClearBtn();
                startSearch();
            }
        }
    });

    searchInput.addEventListener('keydown', function(e) { 
        let list = document.getElementById('custom-dropdown');
        if (list.style.display === 'none') return;
        let items = list.querySelectorAll('li:not(.recent-header-item):not(.no-result-item)');
        if (e.keyCode == 40) { 
            currentFocus++;
            addActive(items);
        } else if (e.keyCode == 38) { 
            currentFocus--;
            addActive(items);
        } else if (e.keyCode == 13) { 
            e.preventDefault();
            let targetVal = this.value; 
            if (list.style.display !== 'none' && items.length > 0) {
                let activeIndex = currentFocus > -1 ? currentFocus : 0; 
                if (items[activeIndex]) targetVal = items[activeIndex].dataset.val;
            }
            if (targetVal) this.value = targetVal;
            this.blur();
            startSearch();
        }
    });

    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        items[currentFocus].classList.add("active");
        items[currentFocus].scrollIntoView({ block: 'nearest', inline: 'start' });
    }

    function removeActive(items) {
        for (let i = 0; i < items.length; i++) items[i].classList.remove("active");
    }
    
    searchInput.addEventListener('blur', () => {
        setTimeout(() => {
            document.getElementById('custom-dropdown').style.display = 'none';
            toggleSearchWrapper(false); 
        }, 200);
    });

    document.getElementById('clear-btn').addEventListener('click', function() { 
        searchInput.value = ''; 
        this.style.display = 'none'; 
        searchInput.focus(); 
        showRecentInDropdown();
    });
    
    document.addEventListener('click', function(e) {
        const regionContainer = document.querySelector('.region-container');
        if (!regionContainer.contains(e.target)) {
            document.getElementById('region-dropdown').style.display = 'none';
            document.getElementById('region-capsule').classList.remove('active');
        }
    });
    
    document.addEventListener('scroll', function(e) {
        if(e.target.classList && e.target.classList.contains('custom-options')) return;
        if(activeDropdownInput) {
            const wrapper = activeDropdownInput.closest('.custom-select-wrapper');
            if (wrapper && wrapper.classList.contains('active')) {
                const globalDropdown = document.getElementById('global-custom-options');
                const rect = wrapper.getBoundingClientRect();
                globalDropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                globalDropdown.style.left = (rect.left + window.scrollX) + 'px';
                globalDropdown.style.width = rect.width + 'px';
            }
        }
    }, true); 

    updateDisconnectBtn(); refreshInitialData();
  });

  function updateActiveNav(mode) {
      document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el => el.classList.remove('active'));
      const targets = document.querySelectorAll(`[data-mode="${mode}"]`);
      targets.forEach(el => el.classList.add('active'));
  }

  function updateMetaThemeColor(mode) {
      const meta = document.getElementById('meta-theme-color');
      if (mode === 'light') { meta.setAttribute('content', '#F0F0F0'); } else { meta.setAttribute('content', '#000000'); }
  }

  function toggleBackgroundInert(isActive) {
      const targets = [ document.getElementById('dynamic-header-wrapper'), document.querySelector('.app-sidebar'), document.querySelector('.mobile-nav-container'), document.querySelector('.container') ];
      targets.forEach(el => { if(el) { if(isActive) el.setAttribute('inert', ''); else el.removeAttribute('inert'); } });
  }

  let transitionTimer = null;
  function switchToMode(mode) {
      // [MODIFIED] Conditional dismiss
      if (currentToastInstance && currentToastMessage !== '구글 시트 연결이 필요합니다.') {
          currentToastInstance.dismiss();
          currentToastInstance = null;
          currentToastMessage = null;
      }

      if (['add', 'move', 'discard'].includes(mode) && !localStorage.getItem(STORAGE_KEY)) {
            // [MODIFIED] Optimized order: Toast first, then switch
            showToast('구글 시트 연결이 필요합니다.', 'warning-yellow black-text');
            switchToMode('settings'); 
            toggleGuide(true); 
            return;
      }
      if (currentMode === mode) return; 
      const previousMode = currentMode;
      currentMode = mode;
      updateActiveNav(mode);
      const body = document.body;
      const searchInput = document.getElementById('card-search');
      if (document.activeElement) { document.activeElement.blur(); }
      
      if (mode === 'home') {
          searchInput.value = ''; document.getElementById('clear-btn').style.display = 'none';
          document.getElementById('custom-dropdown').style.display = 'none'; toggleSearchWrapper(false); searchInput.placeholder = ""; 
      } else if (mode === 'search') { searchInput.placeholder = ""; } 
      else {
          searchInput.value = ''; document.getElementById('clear-btn').style.display = 'none';
          document.getElementById('custom-dropdown').style.display = 'none'; toggleSearchWrapper(false); searchInput.placeholder = "카드 검색"; 
      }
      
      if (mode === 'home') { body.classList.remove('mode-compact'); } else { body.classList.add('mode-compact'); }

      const wrapper = document.getElementById('content-slider-wrapper');
      if (transitionTimer) {
          clearTimeout(transitionTimer); transitionTimer = null;
          wrapper.style.height = wrapper.offsetHeight + 'px';
          const sections = wrapper.querySelectorAll('.content-section');
          sections.forEach(sec => { sec.style.display = 'none'; sec.style.opacity = '0'; sec.style.position = ''; sec.style.width = ''; sec.style.top = ''; sec.style.left = ''; sec.classList.remove('active'); });
          const ghost = document.getElementById('result-ghost'); if(ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
      }

      let targetContentId = '';
      if (mode === 'home') targetContentId = 'intro-area';
      else if (mode === 'search') targetContentId = 'result-content-wrapper'; 
      else if (mode === 'discard') targetContentId = 'discard-content-area';
      else if (mode === 'add') targetContentId = 'add-content-area';
      else if (mode === 'move') { targetContentId = 'move-content-area'; initPageMove(); }
      else if (mode === 'settings') targetContentId = 'settings-content-area'; 

      const currentEl = wrapper.querySelector('.content-section.active');
      const nextEl = document.getElementById(targetContentId);
      if (!wrapper.style.height) { wrapper.style.height = wrapper.offsetHeight + 'px'; }
      if(currentEl) { currentEl.style.position = 'absolute'; currentEl.style.top = '0'; currentEl.style.left = '0'; currentEl.style.width = '100%'; }

      nextEl.style.display = 'block'; nextEl.style.position = 'absolute'; nextEl.style.opacity = '0'; nextEl.style.top = '0'; nextEl.style.left = '0'; nextEl.style.width = '100%';
      const targetHeight = nextEl.scrollHeight;

      requestAnimationFrame(() => {
          wrapper.style.height = targetHeight + 'px'; 
          if(currentEl) currentEl.style.opacity = '0'; 
          nextEl.style.opacity = '1'; 
      });

      transitionTimer = setTimeout(() => {
          wrapper.style.height = ''; 
          if(currentEl) { currentEl.style.display = 'none'; currentEl.classList.remove('active'); currentEl.style.position = ''; currentEl.style.width = ''; }
          nextEl.classList.add('active'); nextEl.style.position = 'relative'; nextEl.style.opacity = ''; nextEl.style.width = ''; nextEl.style.top = ''; nextEl.style.left = '';
          const ghost = document.getElementById('result-ghost'); if(ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
          if ((mode === 'home' || mode === 'discard' || mode === 'add' || mode === 'move' || mode === 'settings') && previousMode === 'search') {
              document.getElementById('result-area').innerHTML = '';
          }
          transitionTimer = null;
      }, 400); 
  }

  function checkClearBtn() { const val = document.getElementById('card-search').value; const btn = document.getElementById('clear-btn'); btn.style.display = val ? 'block' : 'none'; }
  function toggleSearchWrapper(isOpen) { const wrapper = document.getElementById('search-wrapper'); if(isOpen) wrapper.classList.add('active'); else wrapper.classList.remove('active'); }
  function toggleAutoCopy() { isAutoCopyEnabled = document.getElementById('auto-copy-switch').checked; }
  
  function addMoreRows() { console.warn("Called legacy function: addMoreRows"); }
  function submitNewCards() { console.warn("Called legacy function: submitNewCards"); }
  
  function initPageAdd() {
      document.getElementById('page-add-tbody').innerHTML = '';
      addPageEntry();
  }
  
  function adjustAddCount(delta) {
      rowAddCount += delta;
      if(rowAddCount < 1) rowAddCount = 1;
      document.getElementById('add-row-count').innerText = rowAddCount + "장";
  }
  
  function addMultipleRows(e) {
      let firstNewRow = null;
      for(let i=0; i<rowAddCount; i++) {
          const row = addPageEntry();
          if(i === 0) firstNewRow = row;
      }
      if(firstNewRow && e && e.detail === 0) {
          const input = firstNewRow.querySelector('.page-card-no');
          if(input) input.focus();
      }
  }
  
  function addMultipleMoveRows(e) {
      let firstNewRow = null;
      for(let i=0; i<rowMoveCount; i++) {
          const row = addMoveEntry();
          if(i === 0) firstNewRow = row;
      }
      if(firstNewRow && e && e.detail === 0) {
          const input = firstNewRow.querySelector('.card-name-input');
          if(input) input.focus();
      }
  }

  function handleAddButtonKey(e, type) {
      if (e.key === 'ArrowUp') {
          e.preventDefault();
          if(type === 'add') adjustAddCount(1);
          else adjustMoveCount(1);
      } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          if(type === 'add') adjustAddCount(-1);
          else adjustMoveCount(-1);
      }
  }

  function addPageEntry() {
      const tbody = document.getElementById('page-add-tbody');
      const currentCount = tbody.querySelectorAll('tr').length;
      const nextNum = currentCount + 1;
      const isOdd = nextNum % 2 !== 0;
      const groupClass = isOdd ? 'odd' : 'even';

      const tr = document.createElement('tr');
      tr.className = `entry-row entry-group ${groupClass}`;
      
      tr.innerHTML = `
          <td class="no-cell">${nextNum}</td>
          <td class="content-cell">
              <div class="content-wrapper">
                  <div class="entry-row-top">
                      <div class="name-area"><div class="card-name-disp">카드 번호 입력</div></div>
                      <div class="no-area"><input type="text" class="page-card-no" oninput="handleCardNoInput(this)" onblur="fetchCardNameForPage(this)" onkeydown="if(event.key==='Enter') fetchCardNameForPage(this)" placeholder="카드 번호"></div>
                  </div>
                  <div class="entry-row-bottom">
                      <div class="input-wrap w-img">
                          <div class="custom-select-wrapper no-option" id="wrap-add-illust-${nextNum}" data-type="strict">
                            <input type="text" class="custom-input page-card-another" placeholder="일러스트" readonly>
                            <i class="material-icons arrow-icon">arrow_drop_down</i>
                          </div>
                      </div>
                      <div class="input-wrap w-rare">
                          <div class="custom-select-wrapper no-option" id="wrap-add-rare-${nextNum}" data-type="strict">
                            <input type="text" class="custom-input page-card-proc" placeholder="레어도" readonly>
                            <i class="material-icons arrow-icon">arrow_drop_down</i>
                          </div>
                      </div>
                      <div class="input-wrap w-loc">
                          <div class="custom-select-wrapper no-option" id="wrap-add-loc-${nextNum}" data-type="free">
                            <input type="text" class="custom-input page-card-loc" placeholder="보관위치" readonly>
                            <i class="material-icons arrow-icon">arrow_drop_down</i>
                          </div>
                      </div>
                      <div class="input-wrap w-qty"><input type="number" class="page-card-qty" min="1" readonly placeholder="수량"></div>
                  </div>
              </div>
          </td>
          <td class="col-delete" tabindex="0" onclick="deletePageEntry(this)" onkeydown="if(event.key==='Enter') deletePageEntry(this)"><i class="material-icons">delete</i></td>
      `;

      tbody.appendChild(tr);
      reindexRows();
      setupCustomDropdown(tr.querySelector(`#wrap-add-illust-${nextNum}`), null);
      setupCustomDropdown(tr.querySelector(`#wrap-add-rare-${nextNum}`), null);
      setupCustomDropdown(tr.querySelector(`#wrap-add-loc-${nextNum}`), handleAddLocChange);

      const locWrap = tr.querySelector(`#wrap-add-loc-${nextNum}`);
      if(locWrap && typeof allLocations !== 'undefined') {
          locWrap.dataset.options = JSON.stringify(allLocations.map(l => ({ val: l, text: l })));
          if (allLocations.length > 0) locWrap.classList.remove('no-option'); 
      }
      return tr;
  }
  
  function handleAddLocChange(input) {
      const row = input.closest('tr');
      const qtyInp = row.querySelector('.page-card-qty');
      
      if(input.value.trim().length > 0) {
          qtyInp.removeAttribute('readonly');
          if(!qtyInp.value) qtyInp.value = "1";
      } else {
          qtyInp.setAttribute('readonly', true);
          qtyInp.value = "";
      }

      if (!isAutoCopyEnabled) return;
      
      const val = input.value;
      const rows = document.getElementById('page-add-tbody').querySelectorAll('tr');
      let startCopy = false;
      
      rows.forEach(r => {
          if (r === row) { startCopy = true; return; }
          if (startCopy) {
              const nextLocInput = r.querySelector('.page-card-loc');
              const nextQtyInput = r.querySelector('.page-card-qty');
              const wrapper = nextLocInput.closest('.custom-select-wrapper');
              if (!wrapper.classList.contains('no-option')) {
                  nextLocInput.value = val;
                  nextLocInput.removeAttribute('readonly'); 
                  if (val.trim().length > 0) {
                      nextQtyInput.removeAttribute('readonly');
                      if (!nextQtyInput.value) nextQtyInput.value = "1";
                  } else {
                      nextQtyInput.setAttribute('readonly', true);
                      nextQtyInput.value = "";
                  }
              }
          }
      });
  }
  
  function deletePageEntry(btn) {
      const row = btn.closest('tr');
      const tbody = document.getElementById('page-add-tbody');
      if (tbody.querySelectorAll('tr').length <= 1) return;
      tbody.removeChild(row);
      reindexRows();
  }

  function reindexRows() {
      const tbody = document.getElementById('page-add-tbody');
      const rows = tbody.querySelectorAll('tr');
      rows.forEach((row, index) => {
          const num = index + 1;
          const noCell = row.querySelector('.no-cell');
          if (noCell) noCell.innerText = num;
          row.classList.remove('odd', 'even');
          const groupClass = (num % 2 !== 0) ? 'odd' : 'even';
          row.classList.add(groupClass);
          const delBtn = row.querySelector('.col-delete');
          if (rows.length <= 1) { delBtn.classList.add('disabled'); } else { delBtn.classList.remove('disabled'); }
      });
  }

  function handleCardNoInput(input) {
      const start = input.selectionStart;
      input.value = input.value.replace(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/g, '').toUpperCase();
      input.setSelectionRange(start, start);
  }

  async function fetchCardNameForPage(input) {
      const row = input.closest('tr');
      const cardNo = input.value.trim();
      const prevCardNo = input.dataset.prevCardNo;

      if (prevCardNo === cardNo) return; 
      input.dataset.prevCardNo = cardNo; 

      const nameDiv = row.querySelector('.card-name-disp'); 
      const anotherInp = row.querySelector('.page-card-another');
      const anotherWrap = anotherInp.closest('.custom-select-wrapper');
      const procInp = row.querySelector('.page-card-proc');
      const procWrap = procInp.closest('.custom-select-wrapper');
      const locInp = row.querySelector('.page-card-loc'); 
      const locWrap = locInp.closest('.custom-select-wrapper');
      const qtyInput = row.querySelector('.page-card-qty');

      procInp.value = ""; procInp.setAttribute('readonly', true); 
      procWrap.dataset.options = "[]"; procWrap.classList.remove('single-option'); procWrap.classList.add('no-option');
      locInp.value = ""; locInp.setAttribute('readonly', true);
      qtyInput.value = ""; qtyInput.setAttribute('readonly', true);
      anotherInp.value = ""; anotherInp.setAttribute('readonly', true); 
      anotherWrap.dataset.options = "[]"; anotherWrap.classList.remove('single-option'); anotherWrap.classList.add('no-option');

      if (!cardNo) { nameDiv.innerText = "카드 번호 입력"; return; }

      if (clientCache[cardNo]) {
          const cached = clientCache[cardNo];
          if (cached.linkData) {
              const linkId = (cached.linkData.id) ? cached.linkData.id : "/MISSING_CID";
              const linkLocale = (cached.linkData.locale) ? cached.linkData.locale : currentRegion;
              const url = "https://www.db.yugioh-card.com" + linkId + "&request_locale=" + linkLocale;
              nameDiv.innerHTML = `<a href="${url}" target="_blank" class="card-link" onclick="event.stopPropagation()">${cached.name}</a>`;
          } else { nameDiv.innerText = cached.name; }
          applyPageCardDataToRows(cached, row);
          return;
      }

      nameDiv.innerText = "조회 중...";
      try {
          const res = await callApi('getCardNameFromDb', { cardNo });
          if (input.value.trim() !== cardNo) return;
          if (res.name.includes("오류") || res.name.includes("확인하세요")) {
              nameDiv.innerText = res.name;
          } else {
              clientCache[cardNo] = { name: res.name, anotherCount: res.anotherCount, rarities: res.rarities, linkData: res.linkData };
              const linkId = (res.linkData && res.linkData.id) ? res.linkData.id : "/MISSING_CID";
              const linkLocale = (res.linkData && res.linkData.locale) ? res.linkData.locale : currentRegion;
              const url = "https://www.db.yugioh-card.com" + linkId + "&request_locale=" + linkLocale;
              nameDiv.innerHTML = `<a href="${url}" target="_blank" class="card-link" onclick="event.stopPropagation()">${res.name}</a>`;
              applyPageCardDataToRows(res, row);
          }
      } catch (e) {
          if (input.value.trim() !== cardNo) return;
          nameDiv.innerText = "접속 오류";
      }
  }

  function applyPageCardDataToRows(data, row) {
      const anotherInp = row.querySelector('.page-card-another');
      const anotherWrap = anotherInp.closest('.custom-select-wrapper');
      const procInp = row.querySelector('.page-card-proc');
      const procWrap = procInp.closest('.custom-select-wrapper');
      const locInp = row.querySelector('.page-card-loc'); 
      const locWrap = locInp.closest('.custom-select-wrapper');

      const count = data.anotherCount || 1;
      let illustOptions = [];
      
      if (count > 1) {
          illustOptions.push({ val: "기본", text: "기본" });
          for(let i=2; i<=count; i++) {
              let suffix = "th"; if(i===2) suffix="nd"; if(i===3) suffix="rd";
              illustOptions.push({ val: `${i}${suffix}`, text: `${i}${suffix}` });
          }
          anotherWrap.dataset.options = JSON.stringify(illustOptions);
          anotherWrap.classList.remove('single-option');
          anotherWrap.classList.remove('no-option');
      } else {
          anotherInp.value = "기본";
          anotherWrap.classList.add('single-option');
          anotherWrap.classList.remove('no-option');
          anotherWrap.dataset.options = JSON.stringify([{ val: "기본", text: "기본" }]);
      }

      let rareOptions = [];
      if (!data.isFallback && data.rarities && data.rarities.length > 0) {
          rareOptions = data.rarities.map(r => ({ val: r, text: getLocalizedRarity(r) }));
      } else {
          rareOptions = allProcessingTypes.map(p => ({ val: p, text: getLocalizedRarity(p) }));
      }
      
      procWrap.dataset.options = JSON.stringify(rareOptions);
      procWrap.classList.remove('no-option');

      if (rareOptions.length === 1) {
          procInp.value = rareOptions[0].val;
          procWrap.classList.add('single-option');
      } else {
          procInp.value = ""; 
          procWrap.classList.remove('single-option');
      }
      locInp.removeAttribute('readonly'); 
      locWrap.classList.remove('no-option');
  }

  function saveRecentSearch(keyword) {
      if (!keyword) return;
      let recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
      recent = recent.filter(r => r !== keyword);
      recent.unshift(keyword);
      if (recent.length > 5) recent.pop();
      localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
  }

  function toggleResultDetail_Add() { 
      const box = document.getElementById('result-detail-box'); 
      const icon = document.getElementById('toggle-icon'); 
      if (box.style.display !== 'block') { box.style.display = 'block'; icon.innerText = 'keyboard_arrow_up'; } else { box.style.display = 'none'; icon.innerText = 'keyboard_arrow_down'; }
  }

  function toggleResultDetail_Move() { 
      const box = document.getElementById('move-result-detail-box'); 
      const icon = document.getElementById('move-toggle-icon'); 
      if (box.style.display !== 'block') { box.style.display = 'block'; icon.innerText = 'keyboard_arrow_up'; } else { box.style.display = 'none'; icon.innerText = 'keyboard_arrow_down'; }
  }

  function showResultModal(successCount, successQty, detailLog, errorMsg) {
      const modal = document.getElementById('add-result-modal');
      const iconArea = document.getElementById('result-icon-area');
      const successText = document.getElementById('result-success-text');
      const failText = document.getElementById('result-fail-text');
      const summaryBody = document.getElementById('result-summary-body');
      const detailBody = document.getElementById('result-detail-body');
      
      const titleEl = document.getElementById('add-modal-title');
      if (successCount > 0) { titleEl.innerText = "카드 등록 완료!"; } 
      else { titleEl.innerText = "카드 등록 실패!"; }

      summaryBody.innerHTML = ''; detailBody.innerHTML = '';
      successText.innerHTML = ""; failText.innerHTML = "";
      document.getElementById('result-detail-box').style.display = 'none';
      document.getElementById('toggle-icon').innerText = 'keyboard_arrow_down';

      if (errorMsg) {
           iconArea.innerHTML = '<i class="material-icons" style="color: var(--error-red);">error</i>';
           failText.innerText = "오류 발생: " + errorMsg;
           failText.style.color = 'var(--error-red)';
      } else {
           const failCount = detailLog.length - successCount;
           if (failCount === 0) { iconArea.innerHTML = '<i class="material-icons" style="color: var(--success-green);">check_circle</i>'; }
           else if (successCount === 0) { iconArea.innerHTML = '<i class="material-icons" style="color: var(--error-red);">cancel</i>'; }
           else { iconArea.innerHTML = '<i class="material-icons" style="color: var(--warning-yellow);">warning</i>'; }

           if (successCount > 0) { successText.innerHTML = `<div style="margin-bottom:4px;">${successQty}장 성공, ${failCount}건 실패</div>`; }
           else if (failCount > 0) { successText.innerHTML = `<div style="margin-bottom:4px; color:var(--error-red);">${successQty}장 성공, ${failCount}건 실패</div>`; }

           const successLogs = detailLog.filter(l => l.status === 'success');
           if (successLogs.length > 0) {
               const nameAgg = {};
               successLogs.forEach(l => { if(!nameAgg[l.name]) nameAgg[l.name] = 0; nameAgg[l.name] += l.qty; });
               for(const [name, qty] of Object.entries(nameAgg)) {
                   summaryBody.innerHTML += `<tr style="background-color: var(--bg-success);"><td>${name}</td><td style="color:var(--success-green); font-weight:700;">${qty}장</td></tr>`;
               }
           }
           const failLogs = detailLog.filter(l => l.status === 'fail');
           if (failLogs.length > 0) {
               const failAgg = {};
               failLogs.forEach(l => {
                   let reason = l.failReason;
                   if(reason === 'empty_no' || reason === 'invalid_no') reason = "카드 번호 오류";
                   else if(reason === 'no_another') reason = "일러스트 오류";
                   else if(reason === 'no_proc') reason = "레어도 오류";
                   else if(reason === 'invalid_qty') reason = "수량 오류";
                   else if(reason === 'no_loc') reason = "위치 오류";
                   else if(reason === 'loading') reason = "번호 검색 중";

                   if(!failAgg[reason]) failAgg[reason] = 0;
                   failAgg[reason]++;
               });
               for(const [reason, count] of Object.entries(failAgg)) {
                   summaryBody.innerHTML += `<tr style="background-color: var(--bg-fail);"><td style="color:var(--error-red);">${reason}</td><td style="color:var(--error-red); font-weight:700;">${count}건</td></tr>`;
               }
           }
           
           detailLog.forEach((log, idx) => {
               const tr = document.createElement('tr');
               let procTxt = log.proc; let locTxt = log.loc; let qtyTxt = log.qty;
               let anotherTxt = log.another;
               let cardNoStyle = ''; let anotherStyle = ''; let procStyle = ''; let locStyle = ''; let qtyStyle = '';

               if (log.status === 'fail') {
                  if (log.failReason === 'empty_no') {
                      log.cardNo = "미입력"; log.name = "-"; anotherTxt = "-"; procTxt = ""; locTxt = "-"; qtyTxt = "-";
                      cardNoStyle = 'color:var(--error-red); font-weight:700;';
                  } else if (log.failReason === 'invalid_no') {
                      log.cardNo = "카드번호 오류"; log.name = "-"; procTxt = "-"; locTxt = "-"; qtyTxt = "-"; anotherTxt = "-";
                      cardNoStyle = 'color:var(--error-red); font-weight:700;';
                  } else if (log.failReason === 'no_proc') {
                      procTxt = "미선택"; locTxt = "-"; qtyTxt = "-"; procStyle = 'color:var(--error-red); font-weight:700;';
                  } else if (log.failReason === 'no_loc') {
                      locTxt = "미선택"; qtyTxt = "-"; locStyle = 'color:var(--error-red); font-weight:700;';
                  } else if (log.failReason === 'no_another') {
                      anotherTxt = "미선택"; procTxt = "-"; locTxt = "-"; qtyTxt = "-"; anotherStyle = 'color:var(--error-red); font-weight:700;';
                  } else if (log.failReason === 'invalid_qty') {
                      qtyStyle = 'color:var(--error-red); font-weight:700;';
                  } else if (log.failReason === 'loading') { 
                      log.cardNo = "검색 중"; log.name = "-"; anotherTxt = "-"; procTxt = "-"; locTxt = "-"; qtyTxt = "-";
                      cardNoStyle = 'color:var(--error-red); font-weight:700;';
                  }
               }
               tr.innerHTML = `<td>${log.no}</td><td>${log.name}</td><td style="${cardNoStyle}">${log.cardNo}</td><td style="${anotherStyle}">${anotherTxt}</td><td style="${procStyle}">${getLocalizedRarity(procTxt) || "-"}</td><td style="${locStyle}">${locTxt}</td><td style="${qtyStyle}">${qtyTxt}</td>`;
               detailBody.appendChild(tr);
           });
      }
      
      toggleBackgroundInert(true);
      M.Modal.getInstance(modal).open();
  }

  async function submitPageEntries() {
      if(document.getElementById('add-submit-main-btn').classList.contains('disabled')) return;
      const tbody = document.getElementById('page-add-tbody');
      const rows = tbody.querySelectorAll('tr'); 
      
      let hasInput = false;
      rows.forEach(r => {
          if(r.querySelector('.page-card-no').value.trim()) hasInput = true;
      });

      if (!hasInput) {
          showToast('등록할 카드가 없습니다.', 'warning-yellow black-text');
          return;
      }

      const validRows = [];
      const detailLog = [];
      let successCount = 0; let successQty = 0;

      rows.forEach(row => {
          const no = row.querySelector('.no-cell').innerText;
          const cardNo = row.querySelector('.page-card-no').value.trim();
          let nameText = row.querySelector('.card-name-disp').innerText;
          
          if (!cardNo) {
              detailLog.push({ no, name: "", cardNo: "", another: "", proc: "", loc: "", qty: 0, status: 'fail', failReason: 'empty_no' });
              row.dataset.status = 'fail'; return; 
          }

          let another = row.querySelector('.page-card-another').value;
          let proc = row.querySelector('.page-card-proc').value;
          let loc = row.querySelector('.page-card-loc').value.trim();
          const qtyVal = row.querySelector('.page-card-qty').value;
          const qty = parseInt(qtyVal);

          let failReason = null;
          if (nameText === "조회 중...") {
              failReason = "loading";
          } else if (nameText.includes("입력") || nameText.includes("오류") || nameText.includes("확인")) {
              failReason = "invalid_no"; nameText = "유효하지 않은 카드";
          } else if (!another) {
              failReason = "no_another"; another = "미선택";
          } else if (!proc) failReason = "no_proc";
          else if (!loc) failReason = "no_loc";
          else if (!qty || qty < 1) failReason = "invalid_qty";

          if (failReason) {
              detailLog.push({ no, name: nameText, cardNo, another, proc: proc||"미선택", loc: loc||"미선택", qty: qty||0, status: 'fail', failReason });
              row.dataset.status = 'fail'; 
          } else {
              validRows.push([nameText, cardNo, proc, qty, loc, another]);
              detailLog.push({ no, name: nameText, cardNo, another, proc, loc, qty, status: 'success' });
              successCount++; successQty += qty;
              row.dataset.status = 'success'; 
          }
      });

      if (validRows.length > 0) {
          showLoading(true, "등록 중...");
          try {
              await callApi('addCards', {}, validRows);
              showLoading(false);
              showResultModal(successCount, successQty, detailLog);
          } catch (e) {
              showLoading(false);
              showToast('등록 실패: ' + e.toString(), 'red darken-1'); 
              showResultModal(0, 0, [], e.toString());
          }
      } else if (detailLog.length > 0) { 
          showResultModal(0, 0, detailLog); 
      } else {
          showToast('등록 실패: 유효한 데이터가 없습니다.', 'red darken-1');
      }
  }

  function decomposeHangul(str) { const CHO = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ']; const JUNG = ['ㅏ','ㅐ','ㅑ','ㅒ','ㅓ','ㅔ','ㅕ','ㅖ','ㅗ','ㅘ','ㅙ','ㅚ','ㅛ','ㅜ','ㅝ','ㅞ','ㅟ','ㅠ','ㅡ','ㅢ','ㅣ']; const JONG = ['','ㄱ','ㄲ','ㄳ','ㄴ','ㄵ','ㄶ','ㄷ','ㄹ','ㄺ','ㄻ','ㄼ','ㄽ','ㄾ','ㄿ','흐','ㅁ','ㅂ','ㅄ','ㅅ','ㅆ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ']; let result = ""; for (let i = 0; i < str.length; i++) { const charCode = str.charCodeAt(i); if (charCode >= 0xAC00 && charCode <= 0xD7A3) { const code = charCode - 0xAC00; const choIndex = Math.floor(code / 588); const jungIndex = Math.floor((code % 588) / 28); const jongIndex = code % 28; result += CHO[choIndex] + JUNG[jungIndex] + JONG[jongIndex]; } else { result += str.charAt(i); } } return result; }
  function normalizeStr(str) { return str.replace(/\s+/g, '').toLowerCase(); }
  function showRecentInDropdown() { const recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); const list = document.getElementById('custom-dropdown'); currentFocus = -1; Array.from(list.children).forEach(child => { if (!child.classList.contains('recent-header-item')) { child.remove(); } }); let header = list.querySelector('.recent-header-item'); if (!header) { header = document.createElement('li'); header.className = 'recent-header-item'; header.innerHTML = `<span class="recent-title">최근 검색</span><span class="clear-all-btn">전체 제거</span>`; list.prepend(header); } if (recent.length === 0) { const noResultLi = document.createElement('li'); noResultLi.className = 'no-result-item'; noResultLi.innerText = '검색 기록이 없습니다.'; list.appendChild(noResultLi); } else { recent.slice(0, 5).forEach(r => { const li = document.createElement('li'); li.className = 'recent-item-row'; li.dataset.val = r; li.innerHTML = `<span class="recent-text text-suggest">${r}</span><i class="material-icons item-delete-btn">close</i>`; list.appendChild(li); }); } list.style.display = 'block'; toggleSearchWrapper(true); }
  function filterAndShowDropdown(val) { if(!isAppConfigured) return; const list = document.getElementById('custom-dropdown'); const normalizedInput = normalizeStr(val); const decomposedInput = decomposeHangul(normalizedInput); currentFocus = -1; let matches = allNames.filter(name => { const normName = normalizeStr(name); const decompName = decomposeHangul(normName); return decompName.includes(decomposedInput); }); matches.sort((a, b) => { const normVal = normalizedInput; const normA = normalizeStr(a); const normB = normalizeStr(b); if (normA === normVal) return -1; if (normB === normVal) return 1; const aStarts = normA.startsWith(normVal); const bStarts = normB.startsWith(normVal); if (aStarts && !bStarts) return -1; if (!aStarts && bStarts) return 1; return a.length - b.length || a.localeCompare(b); }); list.innerHTML = ''; if (matches.length === 0) { list.innerHTML = '<li class="no-result-item">등록되지 않은 카드</li>'; list.style.display = 'block'; toggleSearchWrapper(true); return; } matches.slice(0, 10).forEach(m => { const li = document.createElement('li'); li.className = 'text-suggest'; li.dataset.val = m; let html = ""; let searchIdx = 0; const lowerM = m.toLowerCase(); const lowerVal = val.toLowerCase().replace(/\s+/g, ''); for(let i=0; i<m.length; i++) { if(searchIdx < lowerVal.length && lowerM[i] === lowerVal[searchIdx]) { html += `<span class="text-match">${m[i]}</span>`; searchIdx++; } else { html += m[i]; } } li.innerHTML = html; list.appendChild(li); }); list.style.display = 'block'; toggleSearchWrapper(true); }
  function deleteRecentItem(name) { let recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); recent = recent.filter(r => r !== name); localStorage.setItem(RECENT_KEY, JSON.stringify(recent)); showRecentInDropdown(); }
  function updateDisconnectBtn() { const btn = document.getElementById('disconnect-btn'); if (localStorage.getItem(STORAGE_KEY)) { btn.classList.remove('disabled'); } else { btn.classList.add('disabled'); } }
  function disconnectSheet() { localStorage.removeItem(STORAGE_KEY); updateDisconnectBtn(); isAppConfigured = false; currentSheetName = ""; document.getElementById('sheet-url').placeholder = "주소 입력 (예 : https://docs.google.com/spreadsheets/...)"; cancelSettings(); showToast('연결이 해제되었습니다.', 'red darken-1'); }
  function saveSettings() { const url = document.getElementById('sheet-url').value.trim(); const match = url.match(/[-\w]{25,}/); if(match) { localStorage.setItem(STORAGE_KEY, match[0]); refreshInitialData(); cancelSettings(); } }
  function cancelSettings() { clearTimeout(validationTimeout); const input = document.getElementById('sheet-url'); const mark = document.getElementById('valid-mark'); const msg = document.getElementById('status-msg'); const confirmBtn = document.getElementById('confirm-btn'); input.value = ''; input.classList.remove('state-error', 'state-warning', 'state-success'); mark.style.display = 'none'; msg.innerText = ''; confirmBtn.classList.add('disabled'); if (currentSheetName) { input.placeholder = "연결됨 : " + currentSheetName; } else { input.placeholder = "주소 입력 (예 : https://docs.google.com/spreadsheets/...)"; } }
  function validateSheetLink() { clearTimeout(validationTimeout); const input = document.getElementById('sheet-url'); const url = input.value.trim(); const mark = document.getElementById('valid-mark'), msg = document.getElementById('status-msg'), confirmBtn = document.getElementById('confirm-btn'); input.classList.remove('state-error', 'state-warning', 'state-success'); if (!url) { mark.style.display = 'none'; msg.innerText = ''; confirmBtn.classList.add('disabled'); return; } const match = url.match(/[-\w]{25,}/); if (!match) { mark.innerHTML = '<i class="material-icons" style="color: var(--error-red)">cancel</i>'; mark.style.display = 'block'; msg.innerText = '구글 시트 링크를 적어주세요.'; msg.style.color = 'var(--error-red)'; input.classList.add('state-error'); confirmBtn.classList.add('disabled'); return; } mark.innerHTML = '<div class="loading-spinner"></div>'; mark.style.display = 'block'; msg.innerText = '확인 중...'; msg.style.color = 'var(--text-secondary)'; validationTimeout = setTimeout(async () => { try { const res = await callApi('checkSheet', { targetId: match[0] }); input.classList.remove('state-error', 'state-warning', 'state-success'); if (res.status === 'OK') { mark.innerHTML = '<i class="material-icons" style="color: var(--success-green)">check_circle</i>'; msg.innerText = '유효한 시트입니다.'; msg.style.color = 'var(--success-green)'; input.classList.add('state-success'); confirmBtn.classList.remove('disabled'); } else { mark.innerHTML = '<i class="material-icons" style="color: var(--warning-yellow)">warning</i>'; msg.innerText = (res.status === 'NO_EDIT_ACCESS') ? '공유 설정을 링크를 가진 모든 사용자 / 편집자로 설정해주세요.' : '접근할 수 없거나 형식이 잘못되었습니다.'; msg.style.color = 'var(--warning-yellow)'; input.classList.add('state-warning'); confirmBtn.classList.add('disabled'); } mark.style.display = 'block'; } catch (e) { input.classList.remove('state-error', 'state-warning', 'state-success'); mark.innerHTML = '<i class="material-icons" style="color: var(--error-red)">error</i>'; msg.innerText = '확인 실패'; msg.style.color = 'var(--error-red)'; input.classList.add('state-error'); } }, 500); }
  function toggleGuide(forceOpen = null) { const btn = document.getElementById('guide-accordion-btn'); const box = document.getElementById('guide-box'); const isOpen = (forceOpen !== null) ? forceOpen : box.style.display === 'none'; box.style.display = isOpen ? 'block' : 'none'; if (isOpen) btn.classList.add('active'); else btn.classList.remove('active'); }
  function loadTheme() { const savedTheme = localStorage.getItem(THEME_KEY); if (savedTheme === 'dark') { document.documentElement.classList.add('dark-mode'); document.getElementById('checkbox-theme').checked = true; updateMetaThemeColor('dark'); } else { updateMetaThemeColor('light'); } }
  function toggleTheme() { if (document.getElementById('checkbox-theme').checked) { document.documentElement.classList.add('dark-mode'); localStorage.setItem(THEME_KEY, 'dark'); updateMetaThemeColor('dark'); } else { document.documentElement.classList.remove('dark-mode'); localStorage.setItem(THEME_KEY, 'light'); updateMetaThemeColor('light'); } }
  const regionMap = { 'ko': '한국', 'ja': '일본', 'ae': '아시아', 'cn': '중국', 'en': '영미', 'de': '독일', 'fr': '프랑스', 'it': '이탈리아', 'es': '스페인', 'pt': '포르투갈' };
  function loadRegion() { const savedRegion = localStorage.getItem(REGION_KEY) || 'ko'; currentRegion = savedRegion; document.getElementById('region-text').innerText = regionMap[savedRegion]; }
  function toggleRegionDropdown(event) { event.stopPropagation(); const list = document.getElementById('region-dropdown'); const capsule = document.getElementById('region-capsule'); if (list.style.display === 'block') { list.style.display = 'none'; capsule.classList.remove('active'); } else { list.style.display = 'block'; capsule.classList.add('active'); } }
  function selectRegion(code, text) { currentRegion = code; localStorage.setItem(REGION_KEY, code); document.getElementById('region-text').innerText = text; document.getElementById('region-dropdown').style.display = 'none'; document.getElementById('region-capsule').classList.remove('active'); }
  async function callApi(action, params = {}, postData = null) { const url = new URL(SCRIPT_URL); url.searchParams.append("action", action); const savedId = localStorage.getItem(STORAGE_KEY); if (savedId) url.searchParams.append("ssId", savedId); for (const key in params) { url.searchParams.append(key, params[key]); } const options = { method: postData ? 'POST' : 'GET' }; if (postData) options.body = JSON.stringify(postData); const response = await fetch(url, options); return await response.json(); }
  function resetAddModal() { document.getElementById('add-card-tbody').innerHTML = ''; addMoreRows(1); }
  async function refreshInitialData() { 
      const savedId = localStorage.getItem(STORAGE_KEY); if (!savedId) return; 
      showLoading(true, "데이터 동기화 중..."); 
      try { 
          const res = await callApi('getInitialData'); 
          showLoading(false); 
          isAppConfigured = res.isConfigured; 
          if (res.isConfigured) { 
              allNames = res.names; 
              allProcessingTypes = res.processingTypes; 
              allLocations = res.locations.sort(); 
              localCardDatabase = res.allCards; 
              rarityMap = res.rarityMap || {}; 
              rarityMappingRaw = res.rarityMappingRaw || []; 
              clientCache = res.clientCache || {}; 
              nameDb = res.nameDb || {}; 
              if (res.sheetName) { currentSheetName = res.sheetName; document.getElementById('sheet-url').placeholder = "연결됨 : " + currentSheetName; } else { currentSheetName = ""; }
              const datalist = document.getElementById('loc-datalist'); datalist.innerHTML = allLocations.map(l => `<option value="${l}">`).join('');
              const distinctNos = new Set(localCardDatabase.map(r => String(r[1]).trim().toUpperCase())); ownedCardNumbers = Array.from(distinctNos).sort();
              nameToNosMap = {}; localCardDatabase.forEach(r => { const name = String(r[0]).trim(); const no = String(r[1]).trim().toUpperCase(); if(!nameToNosMap[name]) nameToNosMap[name] = new Set(); nameToNosMap[name].add(no); }); for(let key in nameToNosMap) { nameToNosMap[key] = Array.from(nameToNosMap[key]).sort(); }
              cidLookup = {}; Object.keys(nameDb).forEach(nameKey => { const entry = nameDb[nameKey]; if (entry && entry.id) { if (!cidLookup[entry.id]) cidLookup[entry.id] = new Set(); cidLookup[entry.id].add(nameKey); } }); 
              const expandedSet = new Set(allNames); allNames.forEach(name => { const entry = nameDb[name]; if (entry && entry.id) { const siblings = cidLookup[entry.id]; if (siblings) { siblings.forEach(sName => expandedSet.add(sName)); } } }); allNames = Array.from(expandedSet).sort(); 
              rarityLookup = {}; rarityMappingRaw.forEach((row, index) => { Object.values(row).forEach(val => { const key = String(val).trim(); if(key) { rarityLookup[key] = { data: row, index: index }; } }); }); 
              const moveRows = document.getElementById('page-move-tbody').querySelectorAll('tr'); moveRows.forEach(row => { const toWrap = row.querySelector('.input-wrap.w-move-to .custom-select-wrapper'); if(toWrap) { toWrap.dataset.options = JSON.stringify(allLocations.map(l => ({ val: l, text: l }))); } });
              const addRows = document.getElementById('page-add-tbody').querySelectorAll('tr'); addRows.forEach(row => { const locWrap = row.querySelector('.input-wrap.w-loc .custom-select-wrapper'); if(locWrap) { locWrap.dataset.options = JSON.stringify(allLocations.map(l => ({ val: l, text: l }))); if (allLocations.length > 0) locWrap.classList.remove('no-option'); } });
              updateDisconnectBtn();
          } 
      } catch (e) { showLoading(false); } 
  }
  
  function startSearch() { 
      if (!localStorage.getItem(STORAGE_KEY)) { showToast('구글 시트 연결이 필요합니다.', 'warning-yellow black-text'); switchToMode('settings'); toggleGuide(true); return; } 
      const name = document.getElementById('card-search').value; if(!name || !isAppConfigured) return; 
      saveRecentSearch(name); 
      let targetNames = new Set(); if (nameDb[name] && nameDb[name].id) { const cid = nameDb[name].id; if (cidLookup[cid]) { targetNames = cidLookup[cid]; } else { targetNames.add(name); } } else { targetNames.add(name); } 
      const filteredRows = localCardDatabase.filter(row => targetNames.has(String(row[0]))); 
      if (currentMode === 'search') {
          const wrapper = document.getElementById('content-slider-wrapper'); const resultArea = document.getElementById('result-area'); const oldHeight = wrapper.offsetHeight; wrapper.style.height = oldHeight + 'px';
          const ghost = resultArea.cloneNode(true); ghost.id = 'result-ghost'; ghost.style.position = 'absolute'; ghost.style.top = '0'; ghost.style.left = '0'; ghost.style.right = '0'; ghost.style.marginLeft = 'auto'; ghost.style.marginRight = 'auto'; ghost.style.marginTop = '0'; ghost.style.paddingTop = '30px'; ghost.style.width = '100%'; ghost.style.maxWidth = '700px'; ghost.style.zIndex = '5'; ghost.style.transition = 'opacity 0.4s ease';
          wrapper.appendChild(ghost); renderTable(filteredRows); resultArea.style.opacity = '0'; resultArea.style.transition = 'opacity 0.4s ease';
          const newHeight = resultArea.offsetHeight; requestAnimationFrame(() => { wrapper.style.height = newHeight + 'px'; ghost.style.opacity = '0'; resultArea.style.opacity = '1'; });
          setTimeout(() => { if(ghost.parentNode) ghost.parentNode.removeChild(ghost); wrapper.style.height = ''; resultArea.style.opacity = ''; resultArea.style.transition = ''; }, 400);
      } else { renderTable(filteredRows); switchToMode('search'); }
      document.getElementById('custom-dropdown').style.display = 'none'; toggleSearchWrapper(false); checkClearBtn(); showLoading(false); 
  }
  
  function findMappingRow(key) { if (!rarityMappingRaw || rarityMappingRaw.length === 0) return null; return rarityMappingRaw.find(row => Object.values(row).includes(key)); }
  function getLocalizedRarity(key) { if (!key) return ""; const info = rarityLookup[key]; if (info && info.data[currentRegion]) { return info.data[currentRegion]; } return key; }
  
  function renderTable(rows) { 
      const resultArea = document.getElementById('result-area'); 
      if (rows.length === 0) { resultArea.innerHTML = "<p class='center'>결과 없음</p>"; return; } 
      const groups = {}; 
      rows.forEach(r => { 
          const cardNo = String(r[1]), proc = String(r[2]), qty = parseInt(r[3]) || 0, loc = String(r[4]);
          const another = String(r[5] || "기본").trim(); 
          if (!groups[cardNo]) groups[cardNo] = { locations: {}, anotherGroups: {} }; 
          if (!groups[cardNo].locations[loc]) groups[cardNo].locations[loc] = { total: 0, procs: {} }; 
          groups[cardNo].locations[loc].total += qty; groups[cardNo].locations[loc].procs[proc] = (groups[cardNo].locations[loc].procs[proc] || 0) + qty; 
          const aKey = `${another}|${loc}`; 
          if (!groups[cardNo].anotherGroups[aKey]) groups[cardNo].anotherGroups[aKey] = { another, loc, total: 0, procs: {} }; 
          groups[cardNo].anotherGroups[aKey].total += qty; groups[cardNo].anotherGroups[aKey].procs[proc] = (groups[cardNo].anotherGroups[aKey].procs[proc] || 0) + qty; 
      }); 
      
      let newHtml = ""; 
      Object.keys(groups).forEach(cardNo => { 
          const rowId = `row-${cardNo}`.replace(/[^a-zA-Z0-9]/g, ''); 
          const cardRows = rows.filter(r => String(r[1]) === cardNo); 
          const totalQty = cardRows.reduce((sum, r) => sum + (parseInt(r[3]) || 0), 0); 
          const locSet = new Set(cardRows.map(r => String(r[4])).filter(l => l)); 
          const distinctKeys = [...new Set(cardRows.map(r => String(r[2]).trim()).filter(k => k))]; 
          distinctKeys.sort((a, b) => { const infoA = rarityLookup[a]; const infoB = rarityLookup[b]; const idxA = infoA ? infoA.index : 999999; const idxB = infoB ? infoB.index : 999999; return idxA - idxB || a.localeCompare(b); }); 
          const displayNamesForSummary = [...new Set(distinctKeys.map(k => rarityMap[k] || k))]; 
          const procStr = displayNamesForSummary.join(", "); 
          const locStr = [...locSet].join(", "); 
          
          const anotherGroups = {}; 
          cardRows.forEach(r => { 
              const another = String(r[5] || "기본").trim(); 
              if(!anotherGroups[another]) anotherGroups[another] = []; 
              anotherGroups[another].push(r); 
          }); 
          
          let leftTableHtml = `<table class="split-table"><thead><tr><th class="fp-col-1">일러스트</th><th class="fp-col-2">보관 위치</th><th class="fp-col-3">총 수량</th></tr></thead><tbody>`; 
          let rightTableHtml = `<table class="split-table"><thead><tr>`; 
          distinctKeys.forEach(key => { const info = rarityLookup[key]; let displayName = key; let tooltipContent = key; if (info) { displayName = info.data.display || key; tooltipContent = info.data[currentRegion] || key; } tooltipContent = tooltipContent.replace(/\(/g, '<br>('); rightTableHtml += `<th class="sp-col tooltipped" data-position="top" data-tooltip="${tooltipContent}">${displayName}</th>`; }); 
          rightTableHtml += `</tr></thead><tbody>`; 
          
          const anotherKeys = Object.keys(anotherGroups).sort((a, b) => { if (a === "기본") return -1; if (b === "기본") return 1; return a.localeCompare(b, undefined, { numeric: true }); }); 
          anotherKeys.forEach(another => { 
              const grpRows = anotherGroups[another]; const locGroups = {}; 
              grpRows.forEach(r => { const loc = String(r[4]); const proc = String(r[2]); const qty = parseInt(r[3]) || 0; if(!locGroups[loc]) locGroups[loc] = { total: 0, procs: {} }; locGroups[loc].total += qty; locGroups[loc].procs[proc] = (locGroups[loc].procs[proc] || 0) + qty; }); 
              const locKeys = Object.keys(locGroups); 
              locKeys.forEach((loc, idx) => { const d = locGroups[loc]; leftTableHtml += `<tr>`; if(idx === 0) leftTableHtml += `<td rowspan="${locKeys.length}">${another}</td>`; leftTableHtml += `<td>${loc}</td><td>${d.total}</td></tr>`; rightTableHtml += `<tr>`; distinctKeys.forEach(key => { const val = d.procs[key] || 0; rightTableHtml += `<td>${val}</td>`; }); rightTableHtml += `</tr>`; }); 
          }); 
          leftTableHtml += `</tbody></table>`; rightTableHtml += `</tbody></table>`; 
          newHtml += ` <div class="new-card-box"> <div class="summary-split-wrapper"> <div class="summary-left">${cardNo}</div> <div class="summary-right"> <table class="summary-table"> <tr><td class="summary-label-cell">보관 위치</td><td class="summary-label-cell">수량</td></tr> <tr><td class="summary-value-cell">${locStr}</td><td class="summary-value-cell">${totalQty}</td></tr> <tr><td class="summary-label-cell border-double-top">보유 레어도</td><td class="summary-value-cell border-double-top">${procStr}</td></tr> </table> </div> </div> <div id="detail-${rowId}" class="detail-slide-wrapper"> <div class="split-table-wrapper"> <div class="fixed-side">${leftTableHtml}</div> <div class="scroll-side">${rightTableHtml}</div> </div> </div> <button class="show-more-btn" onclick="toggleNewDetail('detail-${rowId}')"><span>자세히 보기</span><i class="material-icons tiny">keyboard_arrow_down</i></button> </div> `; 
      }); 
      resultArea.innerHTML = newHtml; 
      M.Tooltip.init(resultArea.querySelectorAll('.tooltipped'), { html: true, margin: 3 }); 
  }
  
  function toggleNewDetail(detailId) {
      const content = document.getElementById(detailId);
      const btn = content.nextElementSibling;
      const textSpan = btn.querySelector('span');
      const icon = btn.querySelector('i');
      if (content.style.maxHeight) { content.style.maxHeight = null; textSpan.innerText = '자세히 보기'; icon.innerText = 'keyboard_arrow_down'; } else { content.style.maxHeight = content.scrollHeight + "px"; textSpan.innerText = '간략히 보기'; icon.innerText = 'keyboard_arrow_up'; }
  }
  
  function showLoading(show, text) { const overlay = document.getElementById('loading-overlay'); const loadingText = document.getElementById('loading-text'); if (show) { overlay.style.display = 'flex'; loadingText.innerText = text; document.body.classList.add('is-loading'); } else { overlay.style.display = 'none'; document.body.classList.remove('is-loading'); } }

  async function handleContinueRegistration() { 
      M.Modal.getInstance(document.getElementById('add-result-modal')).close(); 
      toggleBackgroundInert(false);
      const tbody = document.getElementById('page-add-tbody'); 
      const rows = Array.from(tbody.children); 
      let hasFailures = false; let hasSuccess = false; 
      for (let i = rows.length - 1; i >= 0; i--) { 
          const row = rows[i]; 
          const cardNoVal = row.querySelector('.page-card-no').value.trim();
          if (row.dataset.status === 'success' || !cardNoVal) { 
              tbody.removeChild(row); hasSuccess = true; 
          } else { 
              hasFailures = true; delete row.dataset.status; 
          } 
      }
      if (!hasFailures || tbody.children.length === 0) { addPageEntry(); } reindexRows();
      if (hasSuccess) { await refreshInitialData(); }
  }

  function initPageMove() { const tbody = document.getElementById('page-move-tbody'); if(tbody.children.length === 0) { addMoveEntry(); } }
  function adjustMoveCount(delta) { rowMoveCount += delta; if(rowMoveCount < 1) rowMoveCount = 1; document.getElementById('add-move-count').innerText = rowMoveCount + "건"; }
  function addMultipleMoveRows(e) { let firstNewRow = null; for(let i=0; i<rowMoveCount; i++) { const row = addMoveEntry(); if(i === 0) firstNewRow = row; } if(firstNewRow && e && e.detail === 0) { const input = firstNewRow.querySelector('.card-name-input'); if(input) input.focus(); } }

  function addMoveEntry() {
      const tbody = document.getElementById('page-move-tbody');
      const currentCount = tbody.querySelectorAll('tr').length;
      const nextNum = currentCount + 1;
      const isOdd = nextNum % 2 !== 0;
      const groupClass = isOdd ? 'odd' : 'even';

      const tr = document.createElement('tr');
      tr.className = `entry-row entry-group ${groupClass}`;
      
      tr.innerHTML = `
          <td class="no-cell">${nextNum}</td>
          <td class="content-cell">
              <div class="content-wrapper">
                  <div class="move-row-top">
                      <div class="name-area">
                        <div class="custom-select-wrapper no-arrow" id="wrap-move-name-${nextNum}">
                            <input type="text" class="custom-input card-name-input" placeholder="카드 이름" oninput="handleMoveNameInput(this)" autocomplete="off">
                            <i class="material-icons arrow-icon">arrow_drop_down</i>
                        </div>
                      </div>
                      <div class="no-area">
                        <div class="custom-select-wrapper no-arrow" id="wrap-move-no-${nextNum}">
                            <input type="text" class="custom-input move-card-no" oninput="handleMoveNoInput(this)" onblur="validateMoveNoInput(this)" onkeydown="if(event.key==='Enter') validateMoveNoInput(this)" placeholder="카드 번호" autocomplete="off">
                            <i class="material-icons arrow-icon">arrow_drop_down</i>
                        </div>
                      </div>
                  </div>
                  <div class="move-row-mid">
                      <div class="input-wrap w-move-illust">
                          <div class="custom-select-wrapper no-option" id="wrap-illust-${nextNum}" data-type="strict">
                              <input type="text" class="custom-input move-card-another" placeholder="일러스트" readonly>
                              <i class="material-icons arrow-icon">arrow_drop_down</i>
                          </div>
                      </div>
                      <div class="input-wrap w-move-rare">
                          <div class="custom-select-wrapper no-option" id="wrap-rare-${nextNum}" data-type="strict">
                              <input type="text" class="custom-input move-card-proc" placeholder="레어도" readonly>
                              <i class="material-icons arrow-icon">arrow_drop_down</i>
                          </div>
                      </div>
                  </div>
                  <div class="move-row-bot">
                      <div class="input-wrap w-move-from">
                          <div class="custom-select-wrapper no-option" id="wrap-from-${nextNum}" data-type="strict">
                              <input type="text" class="custom-input move-card-from" placeholder="보관위치">
                              <i class="material-icons arrow-icon">arrow_drop_down</i>
                          </div>
                      </div>
                      <div class="arrow-cell">►</div>
                      <div class="input-wrap w-move-qty"><input type="number" class="move-card-qty" min="1" placeholder="수량"></div>
                      <div class="arrow-cell">►</div>
                      <div class="input-wrap w-move-to">
                          <div class="custom-select-wrapper" id="wrap-to-${nextNum}" data-type="free">
                              <input type="text" class="custom-input move-card-to" placeholder="이동위치">
                              <i class="material-icons arrow-icon">arrow_drop_down</i>
                          </div>
                      </div>
                  </div>
              </div>
          </td>
          <td class="col-delete" tabindex="0" onclick="deleteMoveEntry(this)" onkeydown="if(event.key==='Enter') deleteMoveEntry(this)"><i class="material-icons">delete</i></td>
      `;

      tbody.appendChild(tr);
      setupCustomDropdown(tr.querySelector(`#wrap-illust-${nextNum}`), handleMoveIllustChange);
      setupCustomDropdown(tr.querySelector(`#wrap-rare-${nextNum}`), handleMoveRareChange);
      setupCustomDropdown(tr.querySelector(`#wrap-from-${nextNum}`), handleMoveLocChange);
      setupCustomDropdown(tr.querySelector(`#wrap-to-${nextNum}`), null);
      setupCardNoAutocomplete(tr.querySelector(`#wrap-move-no-${nextNum}`));
      setupCardNameAutocomplete(tr.querySelector(`#wrap-move-name-${nextNum}`));

      const toWrap = tr.querySelector(`#wrap-to-${nextNum}`);
      if(toWrap && typeof allLocations !== 'undefined') { toWrap.dataset.options = JSON.stringify(allLocations.map(l => ({ val: l, text: l }))); }

      const fromInput = tr.querySelector('.move-card-from');
      fromInput.addEventListener('input', function() { const rareVal = tr.querySelector('.move-card-proc').value; if (!rareVal) { this.value = ""; return; } });

      const qtyInput = tr.querySelector('.move-card-qty');
      qtyInput.addEventListener('input', function() { const fromVal = tr.querySelector('.move-card-from').value; if (!fromVal) { this.value = ""; return; } const max = parseInt(this.max); const current = parseInt(this.value); if (!isNaN(max) && current > max) { this.value = max; } });

      reindexMoveRows();
      return tr;
  }
  
  function handleMoveNameInput(input) {
      const row = input.closest('tr');
      const noInput = row.querySelector('.move-card-no');
      const nameVal = input.value.trim();
      if (!input.dataset.programmatic) { noInput.dataset.programmatic = "true"; noInput.value = ""; handleMoveNoInput(noInput); delete noInput.dataset.programmatic; }
      if (nameToNosMap[nameVal]) { const matchedNos = nameToNosMap[nameVal]; if (matchedNos.length === 1) { noInput.value = matchedNos[0]; noInput.dataset.programmatic = "true"; handleMoveNoInput(noInput); validateMoveNoInput(noInput); delete noInput.dataset.programmatic; } }
  }

  function validateMoveNoInput(input) {
      const val = input.value.trim().toUpperCase();
      const row = input.closest('tr');
      const nameInput = row.querySelector('.card-name-input');
      if (!val) { resetMoveRow(row, 'no'); return; }
      if (!ownedCardNumbers.includes(val)) { input.value = ""; input.placeholder = "번호 확인!"; input.classList.add('error-placeholder'); setTimeout(() => { input.placeholder = "카드 번호"; input.classList.remove('error-placeholder'); }, 5000); resetMoveRow(row, 'no'); } 
      else { const matches = localCardDatabase.filter(r => String(r[1]).trim().toUpperCase() === val); if (matches.length > 0) { const name = matches[0][0]; nameInput.dataset.programmatic = "true"; nameInput.value = name; delete nameInput.dataset.programmatic; updateMoveIllusts(row, matches); } }
  }

  function setupCardNameAutocomplete(wrapper) {
      const input = wrapper.querySelector('input');
      const globalDropdown = document.getElementById('global-custom-options');
      let currentFocusIdx = -1;
      const closeDropdown = () => { wrapper.classList.remove('active'); globalDropdown.style.display = 'none'; currentFocusIdx = -1; };
      const renderDropdown = (filtered) => {
          if (filtered.length === 0) { closeDropdown(); return; }
          wrapper.classList.add('active');
          const rect = wrapper.getBoundingClientRect(); globalDropdown.style.top = (rect.bottom + window.scrollY) + 'px'; globalDropdown.style.left = (rect.left + window.scrollX) + 'px'; globalDropdown.style.width = rect.width + 'px';
          globalDropdown.innerHTML = "";
          filtered.forEach(name => { const li = document.createElement('li'); li.className = 'custom-option'; li.innerText = name; li.onmousedown = (e) => e.preventDefault(); li.onclick = () => { input.value = name; closeDropdown(); handleMoveNameInput(input); }; globalDropdown.appendChild(li); });
          globalDropdown.style.display = 'block';
      };
      input.addEventListener('input', () => { const val = input.value.trim(); if (!val) { closeDropdown(); return; } const normalized = normalizeStr(val); const decomposed = decomposeHangul(normalized); const matches = allNames.filter(name => { const normName = normalizeStr(name); const decompName = decomposeHangul(normName); return decompName.includes(decomposed); }).slice(0, 5); renderDropdown(matches); });
      input.addEventListener('focus', () => { if (pendingBlurFn) { clearTimeout(pendingBlurFn); pendingBlurFn = null; } const val = input.value.trim(); if (val) { const normalized = normalizeStr(val); const decomposed = decomposeHangul(normalized); const matches = allNames.filter(name => { const normName = normalizeStr(name); const decompName = decomposeHangul(normName); return decompName.includes(decomposed); }).slice(0, 5); renderDropdown(matches); } else { if(allNames.length > 0) renderDropdown(allNames.slice(0, 5)); } });
      input.addEventListener('blur', () => { const logic = () => closeDropdown(); pendingBlurFn = setTimeout(logic, 200); });
      input.addEventListener('keydown', (e) => {
          if (e.key === 'Tab') {
              if (globalDropdown.style.display === 'block') {
                   let selectedVal = null; const items = globalDropdown.querySelectorAll('li');
                   if (currentFocusIdx > -1 && items[currentFocusIdx]) { selectedVal = items[currentFocusIdx].innerText; } else if (items.length > 0) { selectedVal = items[0].innerText; }
                   if (selectedVal) { input.value = selectedVal; handleMoveNameInput(input); }
                   closeDropdown();
              } return; 
          }
          if (globalDropdown.style.display === 'none') return;
          const items = globalDropdown.querySelectorAll('li');
          if (e.key === 'ArrowDown') { e.preventDefault(); currentFocusIdx++; if (currentFocusIdx >= items.length) currentFocusIdx = 0; updateHighlight(items); } 
          else if (e.key === 'ArrowUp') { e.preventDefault(); currentFocusIdx--; if (currentFocusIdx < 0) currentFocusIdx = items.length - 1; updateHighlight(items); } 
          else if (e.key === 'Enter') { if (currentFocusIdx > -1 && items[currentFocusIdx]) { e.preventDefault(); items[currentFocusIdx].click(); } } 
          else if (e.key === 'Escape') { closeDropdown(); }
      });
      function updateHighlight(items) { items.forEach(i => i.classList.remove('selected')); if (items[currentFocusIdx]) { items[currentFocusIdx].classList.add('selected'); items[currentFocusIdx].scrollIntoView({ block: 'nearest' }); } }
  }

  function setupCardNoAutocomplete(wrapper) {
      const input = wrapper.querySelector('input');
      const globalDropdown = document.getElementById('global-custom-options');
      let currentFocusIdx = -1;
      const closeDropdown = () => { wrapper.classList.remove('active'); globalDropdown.style.display = 'none'; currentFocusIdx = -1; };
      const renderDropdown = (filtered) => {
          if (filtered.length === 0) { closeDropdown(); return; }
          wrapper.classList.add('active');
          const rect = wrapper.getBoundingClientRect(); globalDropdown.style.top = (rect.bottom + window.scrollY) + 'px'; globalDropdown.style.left = (rect.left + window.scrollX) + 'px'; globalDropdown.style.width = rect.width + 'px';
          globalDropdown.innerHTML = "";
          filtered.forEach(no => { const li = document.createElement('li'); li.className = 'custom-option'; li.innerText = no; li.onmousedown = (e) => e.preventDefault(); li.onclick = () => { input.value = no; closeDropdown(); validateMoveNoInput(input); }; globalDropdown.appendChild(li); });
          globalDropdown.style.display = 'block';
      };
      input.addEventListener('input', () => { const val = input.value.trim(); const row = input.closest('tr'); const nameVal = row.querySelector('.card-name-input').value.trim(); let source = ownedCardNumbers; if (nameVal && nameToNosMap[nameVal]) { source = nameToNosMap[nameVal]; } if (!val && !nameVal) { closeDropdown(); return; } const matches = source.filter(no => no.includes(val)).slice(0, 5); renderDropdown(matches); });
      input.addEventListener('focus', () => { if (pendingBlurFn) { clearTimeout(pendingBlurFn); pendingBlurFn = null; } const val = input.value.trim().toUpperCase(); const row = input.closest('tr'); const nameVal = row.querySelector('.card-name-input').value.trim(); let source = ownedCardNumbers; if (nameVal && nameToNosMap[nameVal]) { source = nameToNosMap[nameVal]; } if (val || nameVal) { const matches = source.filter(no => no.includes(val)).slice(0, 5); renderDropdown(matches); } else { if(source.length > 0) renderDropdown(source.slice(0, 5)); } });
      input.addEventListener('blur', () => { const logic = () => { closeDropdown(); validateMoveNoInput(input); }; pendingBlurFn = setTimeout(logic, 200); });
      input.addEventListener('keydown', (e) => {
          if (e.key === 'Tab') {
              if (globalDropdown.style.display === 'block') {
                   let selectedVal = null; const items = globalDropdown.querySelectorAll('li');
                   if (currentFocusIdx > -1 && items[currentFocusIdx]) { selectedVal = items[currentFocusIdx].innerText; } else if (items.length > 0) { selectedVal = items[0].innerText; }
                   if (selectedVal) { input.value = selectedVal; validateMoveNoInput(input); }
                   closeDropdown();
              } return; 
          }
          if (globalDropdown.style.display === 'none') return;
          const items = globalDropdown.querySelectorAll('li');
          if (e.key === 'ArrowDown') { e.preventDefault(); currentFocusIdx++; if (currentFocusIdx >= items.length) currentFocusIdx = 0; updateHighlight(items); } 
          else if (e.key === 'ArrowUp') { e.preventDefault(); currentFocusIdx--; if (currentFocusIdx < 0) currentFocusIdx = items.length - 1; updateHighlight(items); } 
          else if (e.key === 'Enter') { if (currentFocusIdx > -1 && items[currentFocusIdx]) { e.preventDefault(); items[currentFocusIdx].click(); } } 
          else if (e.key === 'Escape') { closeDropdown(); }
      });
      function updateHighlight(items) { items.forEach(i => i.classList.remove('selected')); if (items[currentFocusIdx]) { items[currentFocusIdx].classList.add('selected'); items[currentFocusIdx].scrollIntoView({ block: 'nearest' }); } }
  }

  function setupCustomDropdown(wrapper, changeCallback) {
      const input = wrapper.querySelector('.custom-input');
      const isFreeType = wrapper.dataset.type === 'free';
      let currentFocusIdx = -1;
      const globalDropdown = document.getElementById('global-custom-options');
      const closeDropdown = () => { wrapper.classList.remove('active'); globalDropdown.style.display = 'none'; currentFocusIdx = -1; activeDropdownInput = null; };
      const openDropdown = () => {
          if (pendingBlurFn) { clearTimeout(pendingBlurFn); pendingBlurFn = null; }
          if (input.hasAttribute('readonly') && !input.value && (!wrapper.dataset.options || wrapper.dataset.options === "[]") && !isFreeType) return; 
          if (input.disabled) return;
          if (activeDropdownInput && activeDropdownInput !== input) { activeDropdownInput.blur(); }
          activeDropdownInput = input;
          if (input.classList.contains('move-card-from')) { updateFromLocOptionsDynamic(wrapper); }
          const rawData = JSON.parse(wrapper.dataset.options || "[]");
          if (!isFreeType && rawData.length === 0) return;
          if (rawData.length === 1 && !isFreeType) { return; }
          wrapper.classList.add('active'); renderGlobalDropdown(false); 
      };
      const renderGlobalDropdown = (useFilter = true) => {
          if (!wrapper.classList.contains('active')) return;
          const rawData = JSON.parse(wrapper.dataset.options || "[]");
          const query = input.value;
          const normalized = normalizeStr(query);
          const decomposed = decomposeHangul(normalized);
          let filtered = rawData;
          if (input.classList.contains('move-card-to')) {
              const row = input.closest('tr'); const fromInput = row.querySelector('.move-card-from'); const fromVal = fromInput ? fromInput.value : "";
              if (fromVal) { filtered = filtered.filter(opt => opt.val !== fromVal); }
          }
          if (useFilter && query) { filtered = filtered.filter(opt => decomposeHangul(normalizeStr(opt.text)).includes(decomposed)); }
          const rect = wrapper.getBoundingClientRect(); globalDropdown.style.top = (rect.bottom + window.scrollY) + 'px'; globalDropdown.style.left = (rect.left + window.scrollX) + 'px'; globalDropdown.style.width = rect.width + 'px';
          globalDropdown.innerHTML = "";
          if (filtered.length === 0) { const li = document.createElement('li'); li.className = 'custom-option'; li.style.color = 'var(--text-muted)'; li.style.cursor = 'default'; li.innerText = '일치하는 항목 없음'; globalDropdown.appendChild(li); } 
          else { filtered.forEach((opt, idx) => { const li = document.createElement('li'); li.className = 'custom-option'; if (opt.text === input.value) li.classList.add('selected'); li.innerText = opt.text; li.dataset.val = opt.val; if (opt.max) li.dataset.max = opt.max; li.onmousedown = (e) => e.preventDefault(); li.onclick = () => selectOption(opt); globalDropdown.appendChild(li); }); }
          globalDropdown.style.display = 'block';
      };
      const selectOption = (optData) => { input.value = optData.val; if (optData.max) { input.dataset.maxQty = optData.max; } closeDropdown(); if (changeCallback) changeCallback(input); };
      const updateFromLocOptionsDynamic = (wrap) => {
          const row = wrap.closest('tr'); const cardNo = row.querySelector('.move-card-no').value.trim(); const illust = row.querySelector('.move-card-another').value; const rare = row.querySelector('.move-card-proc').value;
          const matches = localCardDatabase.filter(r => String(r[1]).trim().toUpperCase() === cardNo && String(r[5] || "기본").trim() === illust && String(r[2]).trim() === rare);
          const locMap = {};
          matches.forEach(r => { const loc = String(r[4]).trim(); const qty = parseInt(r[3]) || 0; if (qty > 0) locMap[loc] = (locMap[loc] || 0) + qty; });
          const validLocs = [];
          Object.keys(locMap).forEach(loc => { const avail = getAvailableQty(cardNo, illust, rare, loc, row); if (avail > 0) { validLocs.push({ val: loc, text: `${loc} (잔여: ${avail})`, max: avail }); } });
          validLocs.sort((a,b) => a.val.localeCompare(b.val));
          wrap.dataset.options = JSON.stringify(validLocs);
          if (validLocs.length === 1) wrap.classList.add('single-option'); else wrap.classList.remove('single-option');
          if (validLocs.length === 0) wrap.classList.add('no-option'); else wrap.classList.remove('no-option');
      };
      input.addEventListener('focus', openDropdown); input.addEventListener('click', openDropdown);
      input.addEventListener('blur', () => {
          const logic = () => {
              if (input.classList.contains('move-card-to')) {
                  const row = input.closest('tr'); const fromInput = row.querySelector('.move-card-from');
                  if (fromInput) { const val = input.value.trim(); const fromVal = fromInput.value.trim(); if (val && fromVal && normalizeStr(val) === normalizeStr(fromVal)) { input.value = ""; } }
              }
              const rawData = JSON.parse(wrapper.dataset.options || "[]"); const query = input.value.trim();
              if (!query) { if (rawData.length === 1 && !isFreeType) { selectOption(rawData[0]); } else if (!isFreeType) { input.value = ""; if (changeCallback) changeCallback(input); } closeDropdown(); return; }
              const normalized = normalizeStr(query); const decomposed = decomposeHangul(normalized);
              let filtered = rawData;
              if (input.classList.contains('move-card-to')) { const row = input.closest('tr'); const fromInput = row.querySelector('.move-card-from'); const fromVal = fromInput ? fromInput.value : ""; if (fromVal) { filtered = filtered.filter(opt => opt.val !== fromVal); } }
              filtered = filtered.filter(opt => decomposeHangul(normalizeStr(opt.text)).includes(decomposed));
              if (filtered.length > 0) { selectOption(filtered[0]); } else { if (rawData.length === 1 && !isFreeType) { selectOption(rawData[0]); } else if (!isFreeType) { input.value = ""; if (changeCallback) changeCallback(input); } closeDropdown(); }
          }; pendingBlurFn = setTimeout(logic, 200);
      });
      input.addEventListener('input', (e) => { const rawData = JSON.parse(wrapper.dataset.options || "[]"); if (rawData.length === 1 && !isFreeType) { input.value = rawData[0].val; return; } if (!wrapper.classList.contains('active')) wrapper.classList.add('active'); currentFocusIdx = -1; renderGlobalDropdown(true); });
      input.addEventListener('keydown', (e) => {
          if (!wrapper.classList.contains('active')) { if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { openDropdown(); return; } }
          const items = globalDropdown.querySelectorAll('li:not([style*="default"])');
          if (e.key === 'ArrowDown') { e.preventDefault(); currentFocusIdx++; if (currentFocusIdx >= items.length) currentFocusIdx = 0; updateHighlight(items); } 
          else if (e.key === 'ArrowUp') { e.preventDefault(); currentFocusIdx--; if (currentFocusIdx < 0) currentFocusIdx = items.length - 1; updateHighlight(items); } 
          else if (e.key === 'Enter') { e.preventDefault(); if (currentFocusIdx > -1 && items[currentFocusIdx]) { items[currentFocusIdx].click(); } else { input.blur(); } } 
          else if (e.key === 'Escape') { e.preventDefault(); input.value = ""; input.blur(); closeDropdown(); } 
          else if (e.key === 'Tab') {
               const rawData = JSON.parse(wrapper.dataset.options || "[]"); const query = input.value.trim(); const normalized = normalizeStr(query); const decomposed = decomposeHangul(normalized);
               let filtered = rawData;
               if (input.classList.contains('move-card-to')) { const row = input.closest('tr'); const fromInput = row.querySelector('.move-card-from'); const fromVal = fromInput ? fromInput.value : ""; if (fromVal) { filtered = filtered.filter(opt => opt.val !== fromVal); } }
               if(query) { filtered = filtered.filter(opt => decomposeHangul(normalizeStr(opt.text)).includes(decomposed)); }
               if (currentFocusIdx > -1 && items[currentFocusIdx]) { const opt = { val: items[currentFocusIdx].dataset.val, text: items[currentFocusIdx].innerText, max: items[currentFocusIdx].dataset.max }; selectOption(opt); } else if (filtered.length > 0) { selectOption(filtered[0]); } else if (!isFreeType && rawData.length === 1) { selectOption(rawData[0]); } else if (!isFreeType) { input.value = ""; if (changeCallback) changeCallback(input); }
               if(pendingBlurFn) { clearTimeout(blurTimer); pendingBlurFn = null; } closeDropdown();
          }
      });
      function updateHighlight(items) { items.forEach(i => i.classList.remove('selected')); if (items[currentFocusIdx]) { items[currentFocusIdx].classList.add('selected'); items[currentFocusIdx].scrollIntoView({ block: 'nearest' }); } }
  }

  function deleteMoveEntry(btn) { const row = btn.closest('tr'); const tbody = document.getElementById('page-move-tbody'); if (tbody.querySelectorAll('tr').length <= 1) return; tbody.removeChild(row); reindexMoveRows(); }
  function reindexMoveRows() { const tbody = document.getElementById('page-move-tbody'); const rows = tbody.querySelectorAll('tr'); rows.forEach((row, index) => { const num = index + 1; row.querySelector('.no-cell').innerText = num; row.classList.remove('odd', 'even'); row.classList.add((num % 2 !== 0) ? 'odd' : 'even'); const delBtn = row.querySelector('.col-delete'); if (rows.length <= 1) delBtn.classList.add('disabled'); else delBtn.classList.remove('disabled'); }); }
  function handleMoveNoInput(input) {
      const row = input.closest('tr'); const start = input.selectionStart; input.value = input.value.replace(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/g, '').toUpperCase(); input.setSelectionRange(start, start);
      if (!input.dataset.programmatic) { const nameInput = row.querySelector('.card-name-input'); nameInput.value = ""; }
      const cardNo = input.value.trim().toUpperCase();
      if (!cardNo) { resetMoveRow(row, 'no'); return; }
      const matches = localCardDatabase.filter(r => String(r[1]).trim().toUpperCase() === cardNo);
      if (matches.length > 0) { updateMoveIllusts(row, matches); } else { resetMoveRow(row, 'no'); }
  }
  function resetMoveRow(row, level) {
      const illustInp = row.querySelector('.move-card-another'); const rareInp = row.querySelector('.move-card-proc'); const fromInp = row.querySelector('.move-card-from'); const qtyInput = row.querySelector('.move-card-qty');
      const illustWrap = row.querySelector('[id^="wrap-illust"]'); const rareWrap = row.querySelector('[id^="wrap-rare"]'); const fromWrap = row.querySelector('[id^="wrap-from"]');
      illustWrap.classList.remove('single-option'); rareWrap.classList.remove('single-option'); fromWrap.classList.remove('single-option');
      illustWrap.classList.add('no-option'); rareWrap.classList.add('no-option'); fromWrap.classList.add('no-option');
      if (level === 'no') { illustInp.value = ""; illustInp.setAttribute('readonly', true); illustWrap.dataset.options = "[]"; rareInp.value = ""; rareInp.setAttribute('readonly', true); rareWrap.dataset.options = "[]"; fromInp.value = ""; fromWrap.dataset.options = "[]"; qtyInput.value = ''; }
  }
  function updateMoveIllusts(row, matches) {
      const illustInp = row.querySelector('.move-card-another'); const illustWrap = row.querySelector('[id^="wrap-illust"]');
      const uniqueIllusts = [...new Set(matches.map(r => String(r[5] || "기본").trim()))].sort();
      const options = uniqueIllusts.map(i => ({ val: i, text: i }));
      illustWrap.dataset.options = JSON.stringify(options);
      illustInp.removeAttribute('readonly'); illustWrap.classList.remove('no-option'); 
      const currentVal = illustInp.value; const isValid = options.some(o => o.val === currentVal);
      if (isValid) { handleMoveIllustChange(illustInp); } else { if (options.length === 1) { illustWrap.classList.add('single-option'); illustInp.value = options[0].val; handleMoveIllustChange(illustInp); } else { illustInp.value = ""; illustWrap.classList.remove('single-option'); handleMoveIllustChange(illustInp); } }
  }
  function handleMoveIllustChange(input) {
      const row = input.closest('tr'); const cardNo = row.querySelector('.move-card-no').value.trim(); const selectedIllust = input.value;
      if (!selectedIllust) { const rareInp = row.querySelector('.move-card-proc'); rareInp.value = ""; handleMoveRareChange(rareInp); return; }
      const dbIllust = selectedIllust;
      const matches = localCardDatabase.filter(r => String(r[1]).trim().toUpperCase() === cardNo && String(r[5] || "기본").trim() === dbIllust);
      updateMoveRarities(row, matches);
  }
  function updateMoveRarities(row, matches) {
      const rareInp = row.querySelector('.move-card-proc'); const rareWrap = row.querySelector('[id^="wrap-rare"]'); const uniqueRares = [...new Set(matches.map(r => String(r[2]).trim()))].sort();
      const options = uniqueRares.map(r => ({ val: r, text: getLocalizedRarity(r) }));
      rareWrap.dataset.options = JSON.stringify(options);
      rareInp.removeAttribute('readonly'); rareWrap.classList.remove('no-option'); 
      const currentVal = rareInp.value; const isValid = options.some(o => o.val === currentVal);
      if (isValid) { handleMoveRareChange(rareInp); } else { if (options.length === 1) { rareWrap.classList.add('single-option'); rareInp.value = options[0].val; handleMoveRareChange(rareInp); } else { rareInp.value = ""; rareWrap.classList.remove('single-option'); handleMoveRareChange(rareInp); } }
  }
  function handleMoveRareChange(input) {
      const row = input.closest('tr'); const cardNo = row.querySelector('.move-card-no').value.trim(); const selectedIllust = row.querySelector('.move-card-another').value; const selectedRare = input.value;
      if (!selectedRare) { const fromInp = row.querySelector('.move-card-from'); fromInp.value = ""; handleMoveLocChange(fromInp); return; }
      const dbIllust = selectedIllust;
      const matches = localCardDatabase.filter(r => String(r[1]).trim().toUpperCase() === cardNo && String(r[5] || "기본").trim() === dbIllust && String(r[2]).trim() === selectedRare);
      updateMoveLocations(row, matches);
  }
  function getAvailableQty(cardNo, illust, rare, loc, currentRow) {
      const dbIllust = illust;
      const dbMatches = localCardDatabase.filter(r => String(r[1]).trim().toUpperCase() === cardNo && String(r[5] || "기본").trim() === dbIllust && String(r[2]).trim() === rare && String(r[4]).trim() === loc);
      const totalDbQty = dbMatches.reduce((sum, r) => sum + (parseInt(r[3])||0), 0);
      const allRows = document.getElementById('page-move-tbody').querySelectorAll('tr'); let usedQty = 0;
      allRows.forEach(r => { if (r === currentRow) return; const rNo = r.querySelector('.move-card-no').value.trim().toUpperCase(); const rIllust = r.querySelector('.move-card-another').value; const rRare = r.querySelector('.move-card-proc').value; const rLoc = r.querySelector('.move-card-from').value; const rQty = parseInt(r.querySelector('.move-card-qty').value) || 0; if (rNo === cardNo && rIllust === illust && rRare === rare && rLoc === loc) { usedQty += rQty; } });
      return Math.max(0, totalDbQty - usedQty);
  }
  function updateMoveLocations(row, matches) {
      const fromInp = row.querySelector('.move-card-from'); const fromWrap = row.querySelector('[id^="wrap-from"]'); fromInp.removeAttribute('readonly'); fromWrap.classList.remove('no-option'); 
      const cardNo = row.querySelector('.move-card-no').value.trim(); const illust = row.querySelector('.move-card-another').value; const rare = row.querySelector('.move-card-proc').value; const locMap = {};
      matches.forEach(r => { const loc = String(r[4]).trim(); const qty = parseInt(r[3]) || 0; if (qty > 0) locMap[loc] = (locMap[loc] || 0) + qty; });
      const validLocs = []; Object.keys(locMap).forEach(loc => { const avail = getAvailableQty(cardNo, illust, rare, loc, row); if (avail > 0) { validLocs.push({ val: loc, text: `${loc} (잔여: ${avail})`, max: avail }); } });
      fromWrap.dataset.options = JSON.stringify(validLocs);
      const currentVal = fromInp.value; const validOption = validLocs.find(o => o.val === currentVal);
      if (validOption) { fromInp.dataset.maxQty = validOption.max; handleMoveLocChange(fromInp); } else { if (validLocs.length === 1) { fromWrap.classList.add('single-option'); fromInp.value = validLocs[0].val; fromInp.dataset.maxQty = validLocs[0].max; handleMoveLocChange(fromInp); } else { fromInp.value = ""; fromWrap.classList.remove('single-option'); handleMoveLocChange(fromInp); } }
      if (validLocs.length === 0) fromWrap.classList.add('no-option');
  }
  function handleMoveLocChange(input) {
      const row = input.closest('tr'); const qtyInput = row.querySelector('.move-card-qty'); const maxQty = parseInt(input.dataset.maxQty) || 0;
      const toInput = row.querySelector('.move-card-to'); if (toInput && toInput.value) { const fromVal = input.value.trim(); const toVal = toInput.value.trim(); if (fromVal && normalizeStr(fromVal) === normalizeStr(toVal)) { toInput.value = ""; } }
      if (!input.value) { qtyInput.value = ""; return; }
      if (maxQty > 0) { qtyInput.max = maxQty; qtyInput.placeholder = `최대 ${maxQty}`; const currentQty = parseInt(qtyInput.value); if (!isNaN(currentQty) && currentQty > maxQty) { qtyInput.value = maxQty; } } else { qtyInput.value = ""; qtyInput.placeholder = "재고 없음"; }
  }
  function showMoveResultModal(moves) {
      const modal = document.getElementById('move-result-modal'); const iconArea = document.getElementById('move-icon-area'); const successText = document.getElementById('move-success-text'); const summaryBody = document.getElementById('move-summary-body'); const detailBody = document.getElementById('move-result-body');
      
      const titleEl = document.getElementById('move-modal-title');
      
      summaryBody.innerHTML = ''; detailBody.innerHTML = ''; let successCount = 0; let failCount = 0; let successQty = 0; 
      
      // Calculate Counts based on status
      moves.forEach(m => { 
          if (m.status === 'fail') { failCount++; } 
          else { successCount++; successQty += m.moveQty; } 
      });
      
      if (successCount > 0) { titleEl.innerText = "카드 이동 완료!"; }
      else { titleEl.innerText = "카드 이동 실패!"; }
      
      // Store success state for closing logic
      modal.dataset.hasSuccess = (successCount > 0) ? "true" : "false";

      if (failCount === 0 && successCount > 0) { iconArea.innerHTML = '<i class="material-icons" style="color: var(--success-green);">check_circle</i>'; successText.innerHTML = `<span style="color:var(--text-primary);">${successQty}장 성공, ${failCount}건 실패</span>`; } 
      else if (successCount === 0 && failCount > 0) { iconArea.innerHTML = '<i class="material-icons" style="color: var(--error-red);">cancel</i>'; successText.innerHTML = `<span style="color:var(--error-red);">${successQty}장 성공, ${failCount}건 실패</span>`; } 
      else if (successCount > 0 && failCount > 0) { iconArea.innerHTML = '<i class="material-icons" style="color: var(--warning-yellow);">warning</i>'; successText.innerHTML = `<span>${successQty}장 성공, ${failCount}건 실패</span>`; }
      
      const successMoves = moves.filter(m => m.status !== 'fail');
      if (successMoves.length > 0) { const nameAgg = {}; successMoves.forEach(m => { if(!nameAgg[m.cardName]) nameAgg[m.cardName] = 0; nameAgg[m.cardName] += m.moveQty; }); for(const [name, qty] of Object.entries(nameAgg)) { summaryBody.innerHTML += `<tr style="background-color: var(--bg-success);"><td>${name}</td><td style="color:var(--success-green); font-weight:700;">${qty}장</td></tr>`; } }
      
      const failMoves = moves.filter(m => m.status === 'fail');
      if (failMoves.length > 0) { const failAgg = {}; failMoves.forEach(m => { 
          let reason = "알 수 없는 오류"; const maxQty = m.maxQty || 0; 
          if (!m.cardName) reason = "카드 이름 오류"; 
          else if (!m.cardNo || !ownedCardNumbers.includes(m.cardNo)) reason = "카드 번호 오류"; 
          else if (!m.another) reason = "일러스트 오류"; 
          else if (!m.proc) reason = "레어도 오류"; 
          else if (!m.currentLoc) reason = "보관 위치 오류"; 
          else if (!m.targetLoc) reason = "이동 위치 오류"; 
          else if (!m.moveQty || m.moveQty < 1 || m.moveQty > maxQty) reason = "수량 오류"; 
          
          if(!failAgg[reason]) failAgg[reason] = 0; failAgg[reason]++; 
      }); 
      for(const [reason, count] of Object.entries(failAgg)) { summaryBody.innerHTML += `<tr style="background-color: var(--bg-fail);"><td style="color:var(--error-red);">${reason}</td><td style="color:var(--error-red); font-weight:700;">${count}건</td></tr>`; } }
      
      moves.forEach((move, idx) => { 
          const tr = document.createElement('tr'); 
          let locTxt = `${move.currentLoc} ► ${move.targetLoc}`;
          let qtyTxt = move.moveQty;
          let anotherTxt = move.another;
          let procTxt = getLocalizedRarity(move.proc);
          let cardNoStyle = ''; let nameStyle = ''; let anotherStyle = ''; let procStyle = ''; let locStyle = ''; let qtyStyle = '';

          if (!move.cardNo || !ownedCardNumbers.includes(move.cardNo)) {
              move.cardNo = "오류"; cardNoStyle = 'color:var(--error-red); font-weight:700;';
              anotherTxt = "-"; procTxt = "-"; locTxt = "-"; qtyTxt = "-";
          } 
          else if (!move.another) { 
              anotherTxt = "미선택"; anotherStyle = 'color:var(--error-red); font-weight:700;';
              procTxt = "-"; locTxt = "-"; qtyTxt = "-";
          }
          else if (!move.proc) {
              procTxt = "미선택"; procStyle = 'color:var(--error-red); font-weight:700;';
              locTxt = "-"; qtyTxt = "-";
          }
          else if (!move.currentLoc) {
              locTxt = "보관 위치 오류"; locStyle = 'color:var(--error-red); font-weight:700;';
              qtyTxt = "-";
          }
          else if (!move.targetLoc) {
              locTxt = "이동 위치 오류"; locStyle = 'color:var(--error-red); font-weight:700;';
              qtyTxt = "-";
          }
          else if (!move.moveQty || move.moveQty < 1) {
              qtyTxt = "오류"; qtyStyle = 'color:var(--error-red); font-weight:700;';
          }

          tr.innerHTML = `<td>${idx + 1}</td><td style="${nameStyle}">${move.cardName}</td><td style="${cardNoStyle}">${move.cardNo}</td><td style="${anotherStyle}">${anotherTxt}</td><td style="${procStyle}">${procTxt}</td><td style="${locStyle}">${locTxt}</td><td style="${qtyStyle}">${qtyTxt}</td>`; 
          detailBody.appendChild(tr); 
      });
      
      const box = document.getElementById('move-result-detail-box'); const icon = document.getElementById('move-toggle-icon'); if(box) box.style.display = 'none'; if(icon) icon.innerText = 'keyboard_arrow_down';
      toggleBackgroundInert(true); M.Modal.getInstance(modal).open();
  }
  
  async function finishMoveProcess() { 
      const modal = document.getElementById('move-result-modal');
      const hasSuccess = modal.dataset.hasSuccess === "true"; 
      
      M.Modal.getInstance(modal).close(); 
      toggleBackgroundInert(false); 
      
      const tbody = document.getElementById('page-move-tbody');
      const rows = Array.from(tbody.children);
      
      rows.forEach(row => {
          // [MODIFIED] Cleanup condition: success or empty input
          const cardNoVal = row.querySelector('.move-card-no').value.trim();
          if (row.dataset.moveStatus === 'success' || !cardNoVal) {
              row.remove();
          } else {
              delete row.dataset.moveStatus;
          }
      });
      
      if (tbody.children.length === 0) {
          addMoveEntry();
      } else {
          reindexMoveRows();
      }
      
      if(hasSuccess) { await refreshInitialData(); } 
  }

  async function submitMoveEntries() {
      if(document.getElementById('move-submit-main-btn').classList.contains('disabled')) return;
      const tbody = document.getElementById('page-move-tbody'); const rows = tbody.querySelectorAll('tr'); const moves = []; let failCount = 0;
      rows.forEach(row => {
          const cardNo = row.querySelector('.move-card-no').value.trim(); const cardName = row.querySelector('.card-name-input').value.trim(); const proc = row.querySelector('.move-card-proc').value; const another = row.querySelector('.move-card-another').value; const currentLoc = row.querySelector('.move-card-from').value; const moveQty = parseInt(row.querySelector('.move-card-qty').value); const targetLoc = row.querySelector('.move-card-to').value.trim();
          if (!cardNo) return; 
          const maxQty = parseInt(row.querySelector('.move-card-qty').max) || 0; let isValid = true;
          if (!proc || !currentLoc || !targetLoc || !moveQty || moveQty < 1) isValid = false; if (moveQty > maxQty) isValid = false; 
          
          if (!isValid) {
              failCount++;
              row.dataset.moveStatus = 'fail';
          } else {
              row.dataset.moveStatus = 'pending';
          }
          const submitAnother = another;
          moves.push({ cardNo, cardName, proc, another: submitAnother, currentLoc, targetLoc, moveQty, maxQty, status: isValid ? 'pending' : 'fail' });
      });

      if (moves.length === 0) { showToast('이동할 카드가 없습니다.', 'warning-yellow black-text'); return; }
      if (failCount === moves.length) { showMoveResultModal(moves); return; }

      showLoading(true, "카드 이동 중...");
      const pendingMoves = moves.filter(m => m.status === 'pending');
      try { 
          const res = await callApi('moveCards', {}, pendingMoves); 
          showLoading(false); 
          if (res.success) { 
              rows.forEach(r => { if(r.dataset.moveStatus === 'pending') r.dataset.moveStatus = 'success'; });
              moves.forEach(m => { if(m.status === 'pending') m.status = 'success'; });
              showMoveResultModal(moves); 
          } else { 
              rows.forEach(r => { if(r.dataset.moveStatus === 'pending') r.dataset.moveStatus = 'fail'; });
              showToast('이동 실패: ' + (res.message || '오류 발생'), 'red darken-1'); 
          } 
      } catch (e) { 
          showLoading(false); 
          rows.forEach(r => { if(r.dataset.moveStatus === 'pending') r.dataset.moveStatus = 'fail'; });
          showToast('서버 통신 오류', 'red darken-1'); 
      }
  }
</script>
</body>
</html>
